---
title: "covid_manuscript"
author: "Sucharitha Dodamgodage"
date: "2023-02-13"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```
Packages
```{r}
library(GGally)
library(dplyr)#combine datasets
library(plyr)
library(ggplot2)
library(Hmisc) #correlation with p value
library(knitr)
library(tidyverse,warn.conflicts = F)
library(tidyr)
library(tibble)
library(purrr)
library(sp)
library(moments)
library(MASS)
library(foreign)
library(car)
library(readxl)
library(FSA)
library(ggpubr)#ggarrange
library(svglite)
library(formattable)
library(VGAM)#Generalised poisson
library(gamlss)
library(gamlss.dist)
library(cluster)
library(factoextra)
library(Metrics)#RMSE
library(Ckmeans.1d.dp)
library(readxl)
```

Insert data
```{r}
dataphase1<- read_xlsx("Data/Phase1_complete.xlsx")
dataphase2 <- read_xlsx("Data/Phase2_complete.xlsx")
datafull <- read_xlsx("Data/All_year_complete.xlsx")
```
Split the all year data set based on infection rate cluster
```{r}
cluster_low_inf_datafull<- subset(datafull,datafull$Infection_rate_clusters=="Low")
cluster_medium_inf_datafull<- subset(datafull,datafull$Infection_rate_clusters=="Medium")
cluster_high_inf_datafull<- subset(datafull,datafull$Infection_rate_clusters=="High")
```

Split the all year data set based on fatality rate cluster
```{r}
cluster_low_fat_datafull<- subset(datafull,datafull$Fatality_rate_clusters=="Low")
cluster_medium_fat_datafull<- subset(datafull,datafull$Fatality_rate_clusters=="Medium")
cluster_high_fat_datafull<- subset(datafull,datafull$Fatality_rate_clusters=="High")
```
Split the phase 1 data set based on infection rate cluster
```{r}
cluster_low_inf_dataphase1<- subset(dataphase1,dataphase1$Infection_rate_clusters=="Low")
cluster_medium_inf_dataphase1<- subset(dataphase1,dataphase1$Infection_rate_clusters=="Medium")
cluster_high_inf_dataphase1<- subset(dataphase1,dataphase1$Infection_rate_clusters=="High")
```

Split the phase 1 data set based on fatality rate cluster
```{r}
cluster_low_fat_dataphase1<- subset(dataphase1,dataphase1$Fatality_rate_clusters=="Low")
cluster_medium_fat_dataphase1<- subset(dataphase1,dataphase1$Fatality_rate_clusters=="Medium")
cluster_high_fat_dataphase1<- subset(dataphase1,dataphase1$Fatality_rate_clusters=="High")
```

Split the phase 2 data set based on infection rate cluster
```{r}
cluster_low_inf_dataphase2<- subset(dataphase2,dataphase2$Infection_rate_clusters=="Low")
cluster_medium_inf_dataphase2<- subset(dataphase2,dataphase2$Infection_rate_clusters=="Medium")
cluster_high_inf_dataphase2<- subset(dataphase2,dataphase2$Infection_rate_clusters=="High")
```

Split the phase 2 data set based on fatality rate cluster
```{r}
cluster_low_fat_dataphase2<- subset(dataphase2,dataphase2$Fatality_rate_clusters=="Low")
cluster_medium_fat_dataphase2<- subset(dataphase2,dataphase2$Fatality_rate_clusters=="Medium")
cluster_high_fat_dataphase2<- subset(dataphase2,dataphase2$Fatality_rate_clusters=="High")
```

#########################
Heat maps for correlation
#########################
(Here we have to create 18 plots.Therefore, used the same code and change data set: this is not running for some R versions)

#Correlation plots infection

```{r}
correl<- subset(cluster_low_inf_datafull,select = -c(fips,cases,deaths,population,pctindian,pctasian,Infection_rate_clusters,fatality_rate_10k, Fatality_rate_clusters))

cor<- Hmisc::rcorr(as.matrix(correl),type="pearson")
cor
data.frame(cor$r)%>%head()%>%kable() #correlation values
data.frame(cor$p)%>%head()%>%kable() #p values
data.frame(cor$n)%>%head()%>%kable() #p values

#then we turns each of the three elements of the list(r,n,p)
cors <- function(df) { 
   # turn all three matrices (r, n, and P into a data frame)
   M <- Hmisc::rcorr(as.matrix(df))
   # return the three data frames in a list return(Mdf)
   Mdf <- map(M, ~data.frame(.x))
  }

cors(correl)

#data make ready to plot
cors(correl) %>% 
   map(~rownames_to_column(.x, var="measure1")) %>%
   # look at the first element of the list (r)
   first() %>%
   head() %>%
   kable()

cors(correl) %>%
 map(~rownames_to_column(.x, var="measure1")) %>%
 # format each data set (r,P,n) long
 map(~pivot_longer(.x, -measure1, "measure2")) %>%
 # look at the first element of the list (r)
 first() %>%
 head() %>%
 kable()

#merge our three variables
cors(correl) %>%
 map(~rownames_to_column(.x, var="measure1")) %>%
 # format each data set (r,P,n) long 
 map(~pivot_longer(.x, -measure1, "measure2")) %>%
 # merge our three list elements by binding the rows
 bind_rows(.id = "id") %>%
 head() %>%
 kable()

cors(correl) %>%
 map(~rownames_to_column(.x, var="measure1")) %>%
 # format each data set (r,P,n) long 
 map(~pivot_longer(.x, -measure1, "measure2")) %>%
 # merge our three list elements by binding the rows
 bind_rows(.id = "id") %>%
 pivot_wider(names_from = id, values_from = value) %>%
 head() %>%
 kable()

cors(correl) %>%
 map(~rownames_to_column(.x, var="measure1")) %>%
 # format each data set (r,P,n) long 
 map(~pivot_longer(.x, -measure1, "measure2")) %>%
 # merge our three list elements by binding the rows
 bind_rows(.id = "id") %>%
 pivot_wider(names_from = id, values_from = value) %>%
 mutate(sig_p = ifelse(P < .05, T, F), p_if_sig = ifelse(P <.05, P,NA), r_if_sig = ifelse(r <.05, r, NA)) %>% 
 head() %>%
 kable()

formatted_cors <- function(df){
 cors(df) %>%
 map(~rownames_to_column(.x, var="measure1")) %>%
 map(~pivot_longer(.x, -measure1, "measure2")) %>% 
 bind_rows(.id = "id") %>%
 pivot_wider(names_from = id, values_from = value) %>%
 mutate(sig_p = ifelse(P < .05, T, F), p_if_sig = ifelse(P <.05, P, NA), r_if_sig = ifelse(P <.05, r, NA)) 
}

formatted_cors(correl) %>% head() %>% kable()
```

The simplest form of this plot only requires us to specify measure1 and measure2 on the x and y-axis, respectively. Then we can map the correlation r to the fill aesthetic, and add a tile as the geometry.

We can make some minor aesthetic changes, such as the fill coloring scale, titles, and font family.
We can add the correlations for extra information. For this particular plot, I only added significant (p-value less than 0.05) correlations, using the column r_if_sig that outputs from formatted_cors().

#c('infection_rate_10k','popdense','ageab65','pctpov','pctmale','pctwhite','pctblack','pcthispanic','pct_highschool_or_less','pct_Adults_with_Diabetes','pct_Adults_with_Obesity'))

```{r}

date_cor_pval = formatted_cors(correl)
date_cor_pval["P"][is.na(date_cor_pval["P"])] = 0

#changing the names of variables
date_cor_pval$measure1[date_cor_pval$measure1=='infection_rate_10k']="Infection rate"
date_cor_pval$measure1[date_cor_pval$measure1=='popdense']="Population density"
date_cor_pval$measure1[date_cor_pval$measure1=='ageab65']="Age 65+"
date_cor_pval$measure1[date_cor_pval$measure1=='pctpov']="Poverty"
date_cor_pval$measure1[date_cor_pval$measure1=='pctmale']="Male population"
date_cor_pval$measure1[date_cor_pval$measure1=='pctwhite']="NHW population"
date_cor_pval$measure1[date_cor_pval$measure1=='pctblack']="NHB population"
date_cor_pval$measure1[date_cor_pval$measure1=='pcthispanic']="Hispanic population"
date_cor_pval$measure1[date_cor_pval$measure1=='pct_highschool_or_less']="Education"
date_cor_pval$measure1[date_cor_pval$measure1=='pct_Adults_with_Diabetes']="Diabates"
date_cor_pval$measure1[date_cor_pval$measure1=='pct_Adults_with_Obesity']="Obesity"


date_cor_pval$measure2[date_cor_pval$measure2=='infection_rate_10k']="Infection rate"
date_cor_pval$measure2[date_cor_pval$measure2=='popdense']="Population density"
date_cor_pval$measure2[date_cor_pval$measure2=='ageab65']="Age 65+"
date_cor_pval$measure2[date_cor_pval$measure2=='pctpov']="Poverty"
date_cor_pval$measure2[date_cor_pval$measure2=='pctmale']="Male population"
date_cor_pval$measure2[date_cor_pval$measure2=='pctwhite']="NHW population"
date_cor_pval$measure2[date_cor_pval$measure2=='pctblack']="NHB population"
date_cor_pval$measure2[date_cor_pval$measure2=='pcthispanic']="Hispanic population"
date_cor_pval$measure2[date_cor_pval$measure2=='pct_highschool_or_less']="Education"
date_cor_pval$measure2[date_cor_pval$measure2=='pct_Adults_with_Diabetes']="Diabates"
date_cor_pval$measure2[date_cor_pval$measure2=='pct_Adults_with_Obesity']="Obesity"

date_cor_pval$measure1 = factor(date_cor_pval$measure1, levels = c('Infection rate','Population density','Age 65+','Poverty','Male population','NHW population','NHB population','Hispanic population','Education','Diabates','Obesity'))

date_cor_pval$measure2 = factor(date_cor_pval$measure2, levels = c('Infection rate','Population density','Age 65+','Poverty','Male population','NHW population','NHB population','Hispanic population','Education','Diabates','Obesity'))







g2<-date_cor_pval %>% 
 ggplot(aes(measure1, measure2, fill=r, label=paste(format(round(r,2)),"\n",'(',format(round(P,3)),')', sep = "")  )) +
 geom_tile() +
 labs(x = NULL, y = NULL, fill = "Pearson's\nCorrelation", title="") + scale_fill_gradient2(mid="#FBFEF9",low="#0C6291",high="#A63446", limits=c(-1,1)) +
 geom_text(size = 6)+
 theme_classic() +
 scale_x_discrete(expand=c(0,0)) +
 scale_y_discrete(expand=c(0,0))

g3+ theme(
  # LABLES APPEARANCE
  plot.title = element_text(size=14, colour= "black"),
  axis.title.x = element_text(size=14, colour = "black"),    
  axis.title.y = element_text(size=14, colour = "black"),    
  axis.text.x = element_text(size=14, colour = "black",angle = 45,hjust = 1),
  axis.text.y = element_text(size=14, colour = "black"),
  legend.text = element_text(size=14, colour = "black"),
  legend.title  = element_text(size=14, colour = "black"),
  panel.grid.minor = element_blank(),
)+theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(),
        panel.background = element_blank(), axis.line = element_line(colour = "black"))

ggsave(filename ="g2.svg",width=10,height =8,path = )



```

##Correlation plots Fatality

```{r}
correl<- subset(datafull,select = -c(fips,cases,deaths,population,pctindian,pctasian,Infection_rate_clusters,infection_rate_10k, Infection_rate_clusters))

colnames(correl)
#reorder columns
correl<- correl[,c(11,1,2,3,4,5,6,7,8,9,10)]
colnames(correl)


cor<- Hmisc::rcorr(as.matrix(correl),type="pearson")
cor
data.frame(cor$r)%>%head()%>%kable() #correlation values
data.frame(cor$p)%>%head()%>%kable() #p values
data.frame(cor$n)%>%head()%>%kable() #p values

#then we turns each of the three elements of the list(r,n,p)
cors <- function(df) { 
   # turn all three matrices (r, n, and P into a data frame)
   M <- Hmisc::rcorr(as.matrix(df))
   # return the three data frames in a list return(Mdf)
   Mdf <- map(M, ~data.frame(.x))
  }

cors(correl)

#data make ready to plot
cors(correl) %>% 
   map(~rownames_to_column(.x, var="measure1")) %>%
   # look at the first element of the list (r)
   first() %>%
   head() %>%
   kable()

cors(correl) %>%
 map(~rownames_to_column(.x, var="measure1")) %>%
 # format each data set (r,P,n) long 
 map(~pivot_longer(.x, -measure1, "measure2")) %>%
 # look at the first element of the list (r)
 first() %>%
 head() %>%
 kable()

#merge our three variables
cors(correl) %>%
 map(~rownames_to_column(.x, var="measure1")) %>%
 # format each data set (r,P,n) long 
 map(~pivot_longer(.x, -measure1, "measure2")) %>%
 # merge our three list elements by binding the rows
 bind_rows(.id = "id") %>%
 head() %>%
 kable()

cors(correl) %>%
 map(~rownames_to_column(.x, var="measure1")) %>%
 # format each data set (r,P,n) long 
 map(~pivot_longer(.x, -measure1, "measure2")) %>%
 # merge our three list elements by binding the rows
 bind_rows(.id = "id") %>%
 pivot_wider(names_from = id, values_from = value) %>%
 head() %>%
 kable()

cors(correl) %>%
 map(~rownames_to_column(.x, var="measure1")) %>%
 # format each data set (r,P,n) long 
 map(~pivot_longer(.x, -measure1, "measure2")) %>%
 # merge our three list elements by binding the rows
 bind_rows(.id = "id") %>%
 pivot_wider(names_from = id, values_from = value) %>%
 mutate(sig_p = ifelse(P < .05, T, F), p_if_sig = ifelse(P <.05, P,NA), r_if_sig = ifelse(r <.05, r, NA)) %>% 
 head() %>%
 kable()

formatted_cors <- function(df){
 cors(df) %>%
 map(~rownames_to_column(.x, var=measure1)) %>%
 map(~pivot_longer(.x, -measure1, measure2)) %>% 
 bind_rows(.id = "id") %>%
 pivot_wider(names_from = id, values_from = value) %>%
 mutate(sig_p = ifelse(P < .05, T, F), p_if_sig = ifelse(P <.05, P, NA), r_if_sig = ifelse(P <.05, r, NA)) 
}

formatted_cors(correl) %>% head() %>% kable()
```

The simplest form of this plot only requires us to specify measure1 and measure2 on the x and y-axis, respectively. Then we can map the correlation r to the fill aesthetic, and add a tile as the geometry.

We can make some minor aesthetic changes, such as the fill coloring scale, titles, and font family.
We can add the correlations for extra information. For this particular plot, I only added significant (p-value less than 0.05) correlations, using the column r_if_sig that outputs from formatted_cors().

#c('infection_rate_10k','popdense','ageab65','pctpov','pctmale','pctwhite','pctblack','pcthispanic','pct_highschool_or_less','pct_Adults_with_Diabetes','pct_Adults_with_Obesity'))

```{r}
date_cor_pval = formatted_cors(correl)
date_cor_pval["P"][is.na(date_cor_pval["P"])] = 0.000

#changing the names of variables
date_cor_pval$measure1[date_cor_pval$measure1=='fatality_rate_10k']="Fatality rate"
date_cor_pval$measure1[date_cor_pval$measure1=='popdense']="Population density"
date_cor_pval$measure1[date_cor_pval$measure1=='ageab65']="Age 65+"
date_cor_pval$measure1[date_cor_pval$measure1=='pctpov']="Poverty"
date_cor_pval$measure1[date_cor_pval$measure1=='pctmale']="Male population"
date_cor_pval$measure1[date_cor_pval$measure1=='pctwhite']="NHW population"
date_cor_pval$measure1[date_cor_pval$measure1=='pctblack']="NHB population"
date_cor_pval$measure1[date_cor_pval$measure1=='pcthispanic']="Hispanic population"
date_cor_pval$measure1[date_cor_pval$measure1=='pct_highschool_or_less']="Education"
date_cor_pval$measure1[date_cor_pval$measure1=='pct_Adults_with_Diabetes']="Diabates"
date_cor_pval$measure1[date_cor_pval$measure1=='pct_Adults_with_Obesity']="Obesity"


date_cor_pval$measure2[date_cor_pval$measure2=='fatality_rate_10k']="Fatality rate"
date_cor_pval$measure2[date_cor_pval$measure2=='popdense']="Population density"
date_cor_pval$measure2[date_cor_pval$measure2=='ageab65']="Age 65+"
date_cor_pval$measure2[date_cor_pval$measure2=='pctpov']="Poverty"
date_cor_pval$measure2[date_cor_pval$measure2=='pctmale']="Male population"
date_cor_pval$measure2[date_cor_pval$measure2=='pctwhite']="NHW population"
date_cor_pval$measure2[date_cor_pval$measure2=='pctblack']="NHB population"
date_cor_pval$measure2[date_cor_pval$measure2=='pcthispanic']="Hispanic population"
date_cor_pval$measure2[date_cor_pval$measure2=='pct_highschool_or_less']="Education"
date_cor_pval$measure2[date_cor_pval$measure2=='pct_Adults_with_Diabetes']="Diabates"
date_cor_pval$measure2[date_cor_pval$measure2=='pct_Adults_with_Obesity']="Obesity"

date_cor_pval$measure1 = factor(date_cor_pval$measure1, levels = c('Fatality rate','Population density','Age 65+','Poverty','Male population','NHW population','NHB population','Hispanic population','Education','Diabates','Obesity'))

date_cor_pval$measure2 = factor(date_cor_pval$measure2, levels = c('Fatality rate','Population density','Age 65+','Poverty','Male population','NHW population','NHB population','Hispanic population','Education','Diabates','Obesity'))


g2f<-date_cor_pval %>% 
 ggplot(aes(measure1, measure2, fill=r, label=paste(format(round(r,2)),"\n",'(',format(round(P,3)),')', sep = "")  )) +
 geom_tile() +
 labs(x = NULL, y = NULL, fill = "Pearson's\nCorrelation", title="") + scale_fill_gradient2(mid="#FBFEF9",low="#0C6291",high="#A63446", limits=c(-1,1)) +
 geom_text(size = 6)+
 theme_classic() +
 scale_x_discrete(expand=c(0,0)) +
 scale_y_discrete(expand=c(0,0))

g3f+ theme(
  # LABLES APPEARANCE
  plot.title = element_text(size=14, colour= "black"),
  axis.title.x = element_text(size=14, colour = "black"),    
  axis.title.y = element_text(size=14, colour = "black"),    
  axis.text.x = element_text(size=14, colour = "black",angle = 45,hjust = 1),
  axis.text.y = element_text(size=14, colour = "black"),
  legend.text = element_text(size=14, colour = "black"),
  legend.title  = element_text(size=14, colour = "black"),
  panel.grid.minor = element_blank(),
)+theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(),
        panel.background = element_blank(), axis.line = element_line(colour = "black"))

ggsave(filename ="g2f.svg",width=10,height =8)

```

#############################################
Mean,Variance,Skewness and Kurtosis
#############################################

#All year_low_infection
```{r}
mean(cluster_low_inf_datafull$infection_rate_10k)
sd(cluster_low_inf_datafull$infection_rate_10k)
kurtosis(cluster_low_inf_datafull$infection_rate_10k)
skewness(cluster_low_inf_datafull$infection_rate_10k)
```

#All year_medium_infection
```{r}
mean(cluster_medium_inf_datafull$infection_rate_10k)
sd(cluster_medium_inf_datafull$infection_rate_10k)
kurtosis(cluster_medium_inf_datafull$infection_rate_10k)
skewness(cluster_medium_inf_datafull$infection_rate_10k)
```

#All year_high_infection
```{r}
mean(cluster_high_inf_datafull$infection_rate_10k)
sd(cluster_high_inf_datafull$infection_rate_10k)
kurtosis(cluster_high_inf_datafull$infection_rate_10k)
skewness(cluster_high_inf_datafull$infection_rate_10k)
```

#phase1_low_infection

```{r}
mean(cluster_low_inf_dataphase1$infection_rate_10k)
sd(cluster_low_inf_dataphase1$infection_rate_10k)
kurtosis(cluster_low_inf_dataphase1$infection_rate_10k)
skewness(cluster_low_inf_dataphase1$infection_rate_10k)
```

#phase1_medium_infection

```{r}
mean(cluster_medium_inf_dataphase1$infection_rate_10k)
sd(cluster_medium_inf_dataphase1$infection_rate_10k)
kurtosis(cluster_medium_inf_dataphase1$infection_rate_10k)
skewness(cluster_medium_inf_dataphase1$infection_rate_10k)
```

#phase1_high_infection

```{r}
mean(cluster_high_inf_dataphase1$infection_rate_10k)
sd(cluster_high_inf_dataphase1$infection_rate_10k)
kurtosis(cluster_high_inf_dataphase1$infection_rate_10k)
skewness(cluster_high_inf_dataphase1$infection_rate_10k)
```

#phase2_low_infection
```{r}
mean(cluster_low_inf_dataphase2$infection_rate_10k)
sd(cluster_low_inf_dataphase2$infection_rate_10k)
kurtosis(cluster_low_inf_dataphase2$infection_rate_10k)
skewness(cluster_low_inf_dataphase2$infection_rate_10k)
```

#phase2_medium_infection
```{r}
mean(cluster_medium_inf_dataphase2$infection_rate_10k)
sd(cluster_medium_inf_dataphase2$infection_rate_10k)
kurtosis(cluster_medium_inf_dataphase2$infection_rate_10k)
skewness(cluster_medium_inf_dataphase2$infection_rate_10k)
```
#phase2_high_infection
```{r}
mean(cluster_high_inf_dataphase2$infection_rate_10k)
sd(cluster_high_inf_dataphase2$infection_rate_10k)
kurtosis(cluster_high_inf_dataphase2$infection_rate_10k)
skewness(cluster_high_inf_dataphase2$infection_rate_10k)
```

#all year_low_fatality
```{r}
mean(cluster_low_fat_datafull$infection_rate_10k)
sd(cluster_low_fat_datafull$infection_rate_10k)
kurtosis(cluster_low_fat_datafull$infection_rate_10k)
skewness(cluster_low_fat_datafull$infection_rate_10k)
```
#all year_medium_fatality
```{r}
mean(cluster_medium_fat_datafull$infection_rate_10k)
sd(cluster_medium_fat_datafull$infection_rate_10k)
kurtosis(cluster_medium_fat_datafull$infection_rate_10k)
skewness(cluster_medium_fat_datafull$infection_rate_10k)
```
#all year_high_fatality
```{r}
mean(cluster_high_fat_datafull$infection_rate_10k)
sd(cluster_high_fat_datafull$infection_rate_10k)
kurtosis(cluster_high_fat_datafull$infection_rate_10k)
skewness(cluster_high_fat_datafull$infection_rate_10k)
```
#phase1_low_fatality
```{r}
mean(cluster_low_fat_dataphase1$infection_rate_10k)
sd(cluster_low_fat_dataphase1$infection_rate_10k)
kurtosis(cluster_low_fat_dataphase1$infection_rate_10k)
skewness(cluster_low_fat_dataphase1$infection_rate_10k)
```
#phase1_medium_fatality
```{r}
mean(cluster_medium_fat_dataphase1$infection_rate_10k)
sd(cluster_medium_fat_dataphase1$infection_rate_10k)
kurtosis(cluster_medium_fat_dataphase1$infection_rate_10k)
skewness(cluster_medium_fat_dataphase1$infection_rate_10k)
```
#phase1_high_fatality
```{r}
mean(cluster_high_fat_dataphase1$infection_rate_10k)
sd(cluster_high_fat_dataphase1$infection_rate_10k)
kurtosis(cluster_high_fat_dataphase1$infection_rate_10k)
skewness(cluster_high_fat_dataphase1$infection_rate_10k)
```
#phase2_low_fatality
```{r}
mean(cluster_low_fat_dataphase2$infection_rate_10k)
sd(cluster_low_fat_dataphase2$infection_rate_10k)
kurtosis(cluster_low_fat_dataphase2$infection_rate_10k)
skewness(cluster_low_fat_dataphase2$infection_rate_10k)
```
#phase2_medium_fatality
```{r}
mean(cluster_medium_fat_dataphase2$infection_rate_10k)
sd(cluster_medium_fat_dataphase2$infection_rate_10k)
kurtosis(cluster_medium_fat_dataphase2$infection_rate_10k)
skewness(cluster_medium_fat_dataphase2$infection_rate_10k)
```
#phase2_high_fatality
```{r}
mean(cluster_high_fat_dataphase2$infection_rate_10k)
sd(cluster_high_fat_dataphase2$infection_rate_10k)
kurtosis(cluster_high_fat_dataphase2$infection_rate_10k)
skewness(cluster_high_fat_dataphase2$infection_rate_10k)
```

#############################
KW test
###########################
```{r}
#####infection
#All year 
#normality check
shapiro.test(datafull$popdense)

#KW test
kruskal.test( datafull$pct_Adults_with_Obesity ~ datafull$Infection_rate_clusters, datafull)

dunnTest(datafull$pct_Adults_with_Obesity~ datafull$Infection_rate_clusters, datafull,two.sided = TRUE,method = "none")

#Phase 1
#normality check
shapiro.test(dataphase1$popdense)

#KW test
kruskal.test( dataphase1$pct_Adults_with_Diabetes ~ dataphase1$Infection_rate_clusters, dataphase1)

dunnTest(dataphase1$pct_Adults_with_Diabetes~ dataphase1$Infection_rate_clusters, dataphase1,two.sided = TRUE,method = "none")

#Phase 2
#normality check
shapiro.test(dataphase2$popdense)

#KW test
kruskal.test( dataphase2$pct_Adults_with_Obesity ~ dataphase2$Infection_rate_clusters, dataphase2)

dunnTest(dataphase2$pct_Adults_with_Obesity~ dataphase2$Infection_rate_clusters, dataphase2,two.sided = TRUE,method = "none")


#####fatality
#All year 
#normality check
shapiro.test(datafull$popdense)

#KW test
kruskal.test( datafull$pct_Adults_with_Obesity ~ datafull$Fatality_rate_clusters, datafull)

dunnTest(datafull$pct_Adults_with_Obesity~ datafull$Fatality_rate_clusters, datafull,two.sided = TRUE,method = "none")

#Phase 1
#normality check
shapiro.test(dataphase1$popdense)

#KW test
kruskal.test( dataphase1$pct_Adults_with_Obesity ~ dataphase1$Fatality_rate_clusters, dataphase1)

dunnTest(dataphase1$pct_Adults_with_Obesity~ dataphase1$Fatality_rate_clusters, dataphase1,two.sided = TRUE,method = "none")

#Phase 2
#normality check
shapiro.test(dataphase2$popdense)

#KW test
kruskal.test( dataphase2$pct_Adults_with_Obesity ~ dataphase2$Fatality_rate_clusters, dataphase2)

dunnTest(dataphase2$pct_Adults_with_Obesity~ dataphase2$Fatality_rate_clusters, dataphase2,two.sided = TRUE,method = "none")

```

############################
Regression Analysis
############################

INFECTION

#Phase 1 High infection model 1
```{r}
#Removing outliers
summary(cluster_high_inf_dataphase1$infection_rate_10k)
iqr<-IQR(cluster_high_inf_dataphase1$infection_rate_10k)
Tmax = 149.20+3*iqr #consider extreme outlires
Tmin = 80.05-3*iqr #consider extreme outlires
#outliers
outl<- subset(cluster_high_inf_dataphase1,cluster_high_inf_dataphase1$infection_rate_10k<Tmin| cluster_high_inf_dataphase1$infection_rate_10k>Tmax)
#cleaned data
cleaned_data<- subset(cluster_high_inf_dataphase1,cluster_high_inf_dataphase1$infection_rate_10k>Tmin & cluster_high_inf_dataphase1$infection_rate_10k<Tmax)
#normality test
shapiro.test(cleaned_data$infection_rate_10k)

#summary(cleaned_data$infection_rate_10k)
#Normalize data(since data is not normally distributed we cannot use z score)
#cleaned_data$normalized_infection_rate_10k<- (cleaned_data$infection_rate_10k-63.17)/(321.49-63.17)

#(But fitting NB model to a standardized data doesn't make any sense.Therefore we decided to fit a model after removing outliers)

#Now I fit the NB model for infection_rate_10k in cleaned data

#convert infection rate into integers
cleaned_data$infection_rate_10k_integer<-round(cleaned_data$infection_rate_10k,digits = 0)

#split data set into training and testing
#make this example reproducible
set.seed(1)

#use 70% of dataset as training set and 30% as test set
sample <- sample(c(TRUE, FALSE), nrow(cleaned_data), replace=TRUE, prob=c(0.8,0.2))
train  <- cleaned_data[sample, ]
test   <- cleaned_data[!sample, ]

#fit NB model to training set
summary(m1 <- glm.nb(infection_rate_10k_integer~popdense+ageab65+pctpov+pctmale+pctwhite+pctblack+pcthispanic+pct_highschool_or_less+pct_Adults_with_Diabetes+pct_Adults_with_Obesity,data = train))
vif(m1)

#remove high vif(>5)
summary(m1 <- glm.nb(infection_rate_10k_integer~popdense+ageab65+pctpov+pctmale+pctblack+pcthispanic+pct_highschool_or_less+pct_Adults_with_Diabetes+pct_Adults_with_Obesity,data = train))
vif(m1)



#RMSE for train data
#create new data set using independent varaibles
train_predict<- subset(train, select = -c(infection_rate_10k_integer))
#predict usin fitted NB 
train$predict_infection<- predict(m1, train_predict,type ="response")
rmse_train<-rmse(train$infection_rate_10k_integer,train$predict_infection)
rmse_train

#Normalized RMSE train
Normalized_rmse_train<- rmse_train/mean(train$infection_rate_10k_integer)
Normalized_rmse_train


#RMSE for test data
test_predict<- subset(test, select = -c(infection_rate_10k_integer))
test$predict_infection<- predict(m1, test_predict,type = "response")
rmse_test<- rmse(test$infection_rate_10k_integer,test$predict_infection)
rmse_test


#Normalized RMSE test
Normalized_rmse_test<- rmse_test/mean(test$infection_rate_10k_integer)
Normalized_rmse_test
```

#Phase 1 Medium infection model 2
```{r}
#Removing outliers
summary(cluster_medium_inf_dataphase1$infection_rate_10k)
iqr<-IQR(cluster_medium_inf_dataphase1$infection_rate_10k)
Tmax = 42.09+3*iqr #consider extreme outlires
Tmin = 19.92-3*iqr #consider extreme outlires
#outliers
outl<- subset(cluster_medium_inf_dataphase1,cluster_medium_inf_dataphase1$infection_rate_10k<Tmin| cluster_medium_inf_dataphase1$infection_rate_10k>Tmax)
#cleaned data
cleaned_data<- subset(cluster_medium_inf_dataphase1,cluster_medium_inf_dataphase1$infection_rate_10k>Tmin & cluster_medium_inf_dataphase1$infection_rate_10k<Tmax)
#normality test
shapiro.test(cleaned_data$infection_rate_10k)

#summary(cleaned_data$infection_rate_10k)
#Normalize data(since data is not normally distributed we cannot use z score)
#cleaned_data$normalized_infection_rate_10k<- (cleaned_data$infection_rate_10k-63.17)/(321.49-63.17)

#(But fitting NB model to a standardized data doesn't make any sense.Therefore we decided to fit a model after removing outliers)

#Now I fit the NB model for infection_rate_10k in cleaned data

#convert infection rate into integers
cleaned_data$infection_rate_10k_integer<-round(cleaned_data$infection_rate_10k,digits = 0)

#split data set into training and testing
#make this example reproducible
set.seed(1)

#use 70% of dataset as training set and 30% as test set
sample <- sample(c(TRUE, FALSE), nrow(cleaned_data), replace=TRUE, prob=c(0.8,0.2))
train  <- cleaned_data[sample, ]
test   <- cleaned_data[!sample, ]

#fit NB model to training set
summary(m1 <- glm.nb(infection_rate_10k_integer~popdense+ageab65+pctpov+pctmale+pctwhite+pctblack+pcthispanic+pct_highschool_or_less+pct_Adults_with_Diabetes+pct_Adults_with_Obesity,data = train))
vif(m1)

#remove high vif(>5)
summary(m1 <- glm.nb(infection_rate_10k_integer~popdense+ageab65+pctpov+pctmale+pctblack+pcthispanic+pct_highschool_or_less+pct_Adults_with_Diabetes+pct_Adults_with_Obesity,data = train))
vif(m1)

#RMSE for train data
#create new data set using independent varaibles
train_predict<- subset(train, select = -c(infection_rate_10k_integer))
#predict usin fitted NB 
train$predict_infection<- predict(m1, train_predict,type ="response")
rmse_train<-rmse(train$infection_rate_10k_integer,train$predict_infection)
rmse_train

#Normalized RMSE train
Normalized_rmse_train<- rmse_train/mean(train$infection_rate_10k_integer)
Normalized_rmse_train


#RMSE for test data
test_predict<- subset(test, select = -c(infection_rate_10k_integer))
test$predict_infection<- predict(m1, test_predict,type = "response")
rmse_test<- rmse(test$infection_rate_10k_integer,test$predict_infection)
rmse_test


#Normalized RMSE test
Normalized_rmse_test<- rmse_test/mean(test$infection_rate_10k_integer)
Normalized_rmse_test
```

#Phase 1 Low infection model 3
```{r}
#Removing outliers
summary(cluster_low_inf_dataphase1$infection_rate_10k)
iqr<-IQR(cluster_low_inf_dataphase1$infection_rate_10k)
Tmax = 9.8723+3*iqr #consider extreme outlires
Tmin = 4.8041-3*iqr #consider extreme outlires
#outliers
outl<- subset(cluster_low_inf_dataphase1,cluster_low_inf_dataphase1$infection_rate_10k<Tmin| cluster_low_inf_dataphase1$infection_rate_10k>Tmax)
#cleaned data
cleaned_data<- subset(cluster_low_inf_dataphase1,cluster_low_inf_dataphase1$infection_rate_10k>Tmin & cluster_low_inf_dataphase1$infection_rate_10k<Tmax)
#normality test
shapiro.test(cleaned_data$infection_rate_10k)

#summary(cleaned_data$infection_rate_10k)
#Normalize data(since data is not normally distributed we cannot use z score)
#cleaned_data$normalized_infection_rate_10k<- (cleaned_data$infection_rate_10k-63.17)/(321.49-63.17)

#(But fitting NB model to a standardized data doesn't make any sense.Therefore we decided to fit a model after removing outliers)

#Now I fit the NB model for infection_rate_10k in cleaned data

#convert infection rate into integers
cleaned_data$infection_rate_10k_integer<-round(cleaned_data$infection_rate_10k,digits = 0)

#split data set into training and testing
#make this example reproducible
set.seed(1)

#use 70% of dataset as training set and 30% as test set
sample <- sample(c(TRUE, FALSE), nrow(cleaned_data), replace=TRUE, prob=c(0.8,0.2))
train  <- cleaned_data[sample, ]
test   <- cleaned_data[!sample, ]

#fit NB model to training set
summary(m1 <- glm.nb(infection_rate_10k_integer~popdense+ageab65+pctpov+pctmale+pctwhite+pctblack+pcthispanic+pct_highschool_or_less+pct_Adults_with_Diabetes+pct_Adults_with_Obesity,data = train))
vif(m1)


#RMSE for train data
#create new data set using independent varaibles
train_predict<- subset(train, select = -c(infection_rate_10k_integer))
#predict usin fitted NB 
train$predict_infection<- predict(m1, train_predict,type ="response")
rmse_train<-rmse(train$infection_rate_10k_integer,train$predict_infection)
rmse_train

#Normalized RMSE train
Normalized_rmse_train<- rmse_train/mean(train$infection_rate_10k_integer)
Normalized_rmse_train


#RMSE for test data
test_predict<- subset(test, select = -c(infection_rate_10k_integer))
test$predict_infection<- predict(m1, test_predict,type = "response")
rmse_test<- rmse(test$infection_rate_10k_integer,test$predict_infection)
rmse_test


#Normalized RMSE test
Normalized_rmse_test<- rmse_test/mean(test$infection_rate_10k_integer)
Normalized_rmse_test
```

#Phase 2 high infection model 4
```{r}
#Removing outliers
summary(cluster_high_inf_dataphase2$infection_rate_10k)
iqr<-IQR(cluster_high_inf_dataphase2$infection_rate_10k)
Tmax = 1006.8+3*iqr #consider extreme outlires
Tmin = 815.2-3*iqr #consider extreme outlires
#outliers
outl<- subset(cluster_high_inf_dataphase2,cluster_high_inf_dataphase2$infection_rate_10k<Tmin| cluster_high_inf_dataphase2$infection_rate_10k>Tmax)
#cleaned data
cleaned_data<- subset(cluster_high_inf_dataphase2,cluster_high_inf_dataphase2$infection_rate_10k>Tmin & cluster_high_inf_dataphase2$infection_rate_10k<Tmax)
#normality test
shapiro.test(cleaned_data$infection_rate_10k)

#summary(cleaned_data$infection_rate_10k)
#Normalize data(since data is not normally distributed we cannot use z score)
#cleaned_data$normalized_infection_rate_10k<- (cleaned_data$infection_rate_10k-63.17)/(321.49-63.17)

#(But fitting NB model to a standardized data doesn't make any sense.Therefore we decided to fit a model after removing outliers)

#Now I fit the NB model for infection_rate_10k in cleaned data

#convert infection rate into integers
cleaned_data$infection_rate_10k_integer<-round(cleaned_data$infection_rate_10k,digits = 0)

#split data set into training and testing
#make this example reproducible
set.seed(1)

#use 70% of dataset as training set and 30% as test set
sample <- sample(c(TRUE, FALSE), nrow(cleaned_data), replace=TRUE, prob=c(0.8,0.2))
train  <- cleaned_data[sample, ]
test   <- cleaned_data[!sample, ]

#fit NB model to training set
summary(m1 <- glm.nb(infection_rate_10k_integer~popdense+ageab65+pctpov+pctmale+pctwhite+pctblack+pcthispanic+pct_highschool_or_less+pct_Adults_with_Diabetes+pct_Adults_with_Obesity,data = train))
vif(m1)

summary(m1 <- glm.nb(infection_rate_10k_integer~popdense+ageab65+pctpov+pctmale+pctblack+pcthispanic+pct_highschool_or_less+pct_Adults_with_Diabetes+pct_Adults_with_Obesity,data = train))
vif(m1)

#RMSE for train data
#create new data set using independent varaibles
train_predict<- subset(train, select = -c(infection_rate_10k_integer))
#predict usin fitted NB 
train$predict_infection<- predict(m1, train_predict,type ="response")
rmse_train<-rmse(train$infection_rate_10k_integer,train$predict_infection)
rmse_train

#Normalized RMSE train
Normalized_rmse_train<- rmse_train/mean(train$infection_rate_10k_integer)
Normalized_rmse_train


#RMSE for test data
test_predict<- subset(test, select = -c(infection_rate_10k_integer))
test$predict_infection<- predict(m1, test_predict,type = "response")
rmse_test<- rmse(test$infection_rate_10k_integer,test$predict_infection)
rmse_test


#Normalized RMSE test
Normalized_rmse_test<- rmse_test/mean(test$infection_rate_10k_integer)
Normalized_rmse_test
```


#Phase 2 medium infection model 5
```{r}
#Removing outliers
summary(cluster_medium_inf_dataphase2$infection_rate_10k)
iqr<-IQR(cluster_medium_inf_dataphase2$infection_rate_10k)
Tmax = 672.4+3*iqr #consider extreme outlires
Tmin = 526.0-3*iqr #consider extreme outlires
#outliers
outl<- subset(cluster_medium_inf_dataphase2,cluster_medium_inf_dataphase2$infection_rate_10k<Tmin| cluster_medium_inf_dataphase2$infection_rate_10k>Tmax)
#cleaned data
cleaned_data<- subset(cluster_medium_inf_dataphase2,cluster_medium_inf_dataphase2$infection_rate_10k>Tmin & cluster_medium_inf_dataphase2$infection_rate_10k<Tmax)
#normality test
shapiro.test(cleaned_data$infection_rate_10k)

#summary(cleaned_data$infection_rate_10k)
#Normalize data(since data is not normally distributed we cannot use z score)
#cleaned_data$normalized_infection_rate_10k<- (cleaned_data$infection_rate_10k-63.17)/(321.49-63.17)

#(But fitting NB model to a standardized data doesn't make any sense.Therefore we decided to fit a model after removing outliers)

#Now I fit the NB model for infection_rate_10k in cleaned data

#convert infection rate into integers
cleaned_data$infection_rate_10k_integer<-round(cleaned_data$infection_rate_10k,digits = 0)

#split data set into training and testing
#make this example reproducible
set.seed(1)

#use 70% of dataset as training set and 30% as test set
sample <- sample(c(TRUE, FALSE), nrow(cleaned_data), replace=TRUE, prob=c(0.8,0.2))
train  <- cleaned_data[sample, ]
test   <- cleaned_data[!sample, ]

#fit NB model to training set
summary(m1 <- glm.nb(infection_rate_10k_integer~popdense+ageab65+pctpov+pctmale+pctwhite+pctblack+pcthispanic+pct_highschool_or_less+pct_Adults_with_Diabetes+pct_Adults_with_Obesity,data = train))
vif(m1)

summary(m1 <- glm.nb(infection_rate_10k_integer~popdense+ageab65+pctpov+pctmale+pctblack+pcthispanic+pct_highschool_or_less+pct_Adults_with_Diabetes+pct_Adults_with_Obesity,data = train))
vif(m1)

#RMSE for train data
#create new data set using independent varaibles
train_predict<- subset(train, select = -c(infection_rate_10k_integer))
#predict usin fitted NB 
train$predict_infection<- predict(m1, train_predict,type ="response")
rmse_train<-rmse(train$infection_rate_10k_integer,train$predict_infection)
rmse_train

#Normalized RMSE train
Normalized_rmse_train<- rmse_train/mean(train$infection_rate_10k_integer)
Normalized_rmse_train


#RMSE for test data
test_predict<- subset(test, select = -c(infection_rate_10k_integer))
test$predict_infection<- predict(m1, test_predict,type = "response")
rmse_test<- rmse(test$infection_rate_10k_integer,test$predict_infection)
rmse_test


#Normalized RMSE test
Normalized_rmse_test<- rmse_test/mean(test$infection_rate_10k_integer)
Normalized_rmse_test
```


#Phase 2 low infection model 6
```{r}
#Removing outliers
summary(cluster_low_inf_dataphase2$infection_rate_10k)
iqr<-IQR(cluster_low_inf_dataphase2$infection_rate_10k)
Tmax = 395.4+3*iqr #consider extreme outlires
Tmin = 250.1-3*iqr #consider extreme outlires
#outliers
outl<- subset(cluster_low_inf_dataphase2,cluster_low_inf_dataphase2$infection_rate_10k<Tmin| cluster_low_inf_dataphase2$infection_rate_10k>Tmax)
#cleaned data
cleaned_data<- subset(cluster_low_inf_dataphase2,cluster_low_inf_dataphase2$infection_rate_10k>Tmin & cluster_low_inf_dataphase2$infection_rate_10k<Tmax)
#normality test
shapiro.test(cleaned_data$infection_rate_10k)

#summary(cleaned_data$infection_rate_10k)
#Normalize data(since data is not normally distributed we cannot use z score)
#cleaned_data$normalized_infection_rate_10k<- (cleaned_data$infection_rate_10k-63.17)/(321.49-63.17)

#(But fitting NB model to a standardized data doesn't make any sense.Therefore we decided to fit a model after removing outliers)

#Now I fit the NB model for infection_rate_10k in cleaned data

#convert infection rate into integers
cleaned_data$infection_rate_10k_integer<-round(cleaned_data$infection_rate_10k,digits = 0)

#split data set into training and testing
#make this example reproducible
set.seed(1)

#use 70% of dataset as training set and 30% as test set
sample <- sample(c(TRUE, FALSE), nrow(cleaned_data), replace=TRUE, prob=c(0.8,0.2))
train  <- cleaned_data[sample, ]
test   <- cleaned_data[!sample, ]

#fit NB model to training set
summary(m1 <- glm.nb(infection_rate_10k_integer~popdense+ageab65+pctpov+pctmale+pctwhite+pctblack+pcthispanic+pct_highschool_or_less+pct_Adults_with_Diabetes+pct_Adults_with_Obesity,data = train))
vif(m1)

summary(m1 <- glm.nb(infection_rate_10k_integer~popdense+ageab65+pctpov+pctmale+pctblack+pcthispanic+pct_highschool_or_less+pct_Adults_with_Diabetes+pct_Adults_with_Obesity,data = train))
vif(m1)

#RMSE for train data
#create new data set using independent varaibles
train_predict<- subset(train, select = -c(infection_rate_10k_integer))
#predict usin fitted NB 
train$predict_infection<- predict(m1, train_predict,type ="response")
rmse_train<-rmse(train$infection_rate_10k_integer,train$predict_infection)
rmse_train

#Normalized RMSE train
Normalized_rmse_train<- rmse_train/mean(train$infection_rate_10k_integer)
Normalized_rmse_train


#RMSE for test data
test_predict<- subset(test, select = -c(infection_rate_10k_integer))
test$predict_infection<- predict(m1, test_predict,type = "response")
rmse_test<- rmse(test$infection_rate_10k_integer,test$predict_infection)
rmse_test


#Normalized RMSE test
Normalized_rmse_test<- rmse_test/mean(test$infection_rate_10k_integer)
Normalized_rmse_test
```

#All year high infection model 7
```{r}
#Removing outliers
summary(cluster_high_inf_datafull$infection_rate_10k)
iqr<-IQR(cluster_high_inf_datafull$infection_rate_10k)
Tmax = 1082.3+3*iqr #consider extreme outlires
Tmin = 876.1 -3*iqr #consider extreme outlires
#outliers
outl<- subset(cluster_high_inf_datafull,cluster_high_inf_datafull$infection_rate_10k<Tmin| cluster_high_inf_datafull$infection_rate_10k>Tmax)
#cleaned data
cleaned_data<- subset(cluster_high_inf_datafull,cluster_high_inf_datafull$infection_rate_10k>Tmin & cluster_high_inf_datafull$infection_rate_10k<Tmax)
#normality test
shapiro.test(cleaned_data$infection_rate_10k)

#summary(cleaned_data$infection_rate_10k)
#Normalize data(since data is not normally distributed we cannot use z score)
#cleaned_data$normalized_infection_rate_10k<- (cleaned_data$infection_rate_10k-63.17)/(321.49-63.17)

#(But fitting NB model to a standardized data doesn't make any sense.Therefore we decided to fit a model after removing outliers)

#Now I fit the NB model for infection_rate_10k in cleaned data

#convert infection rate into integers
cleaned_data$infection_rate_10k_integer<-round(cleaned_data$infection_rate_10k,digits = 0)

#split data set into training and testing
#make this example reproducible
set.seed(1)

#use 70% of dataset as training set and 30% as test set
sample <- sample(c(TRUE, FALSE), nrow(cleaned_data), replace=TRUE, prob=c(0.8,0.2))
train  <- cleaned_data[sample, ]
test   <- cleaned_data[!sample, ]

#fit NB model to training set
summary(m1 <- glm.nb(infection_rate_10k_integer~popdense+ageab65+pctpov+pctmale+pctwhite+pctblack+pcthispanic+pct_highschool_or_less+pct_Adults_with_Diabetes+pct_Adults_with_Obesity,data = train))
vif(m1)

summary(m1 <- glm.nb(infection_rate_10k_integer~popdense+ageab65+pctpov+pctmale+pctblack+pcthispanic+pct_highschool_or_less+pct_Adults_with_Diabetes+pct_Adults_with_Obesity,data = train))
vif(m1)


#RMSE for train data
#create new data set using independent varaibles
train_predict<- subset(train, select = -c(infection_rate_10k_integer))
#predict usin fitted NB 
train$predict_infection<- predict(m1, train_predict,type ="response")
rmse_train<-rmse(train$infection_rate_10k_integer,train$predict_infection)
rmse_train

#Normalized RMSE train
Normalized_rmse_train<- rmse_train/mean(train$infection_rate_10k_integer)
Normalized_rmse_train


#RMSE for test data
test_predict<- subset(test, select = -c(infection_rate_10k_integer))
test$predict_infection<- predict(m1, test_predict,type = "response")
rmse_test<- rmse(test$infection_rate_10k_integer,test$predict_infection)
rmse_test


#Normalized RMSE test
Normalized_rmse_test<- rmse_test/mean(test$infection_rate_10k_integer)
Normalized_rmse_test
```

#All year medium infection model 8
```{r}
#Removing outliers
summary(cluster_medium_inf_datafull$infection_rate_10k)
iqr<-IQR(cluster_medium_inf_datafull$infection_rate_10k)
Tmax = 724.5+3*iqr #consider extreme outlires
Tmin = 577.1 -3*iqr #consider extreme outlires
#outliers
outl<- subset(cluster_medium_inf_datafull,cluster_medium_inf_datafull$infection_rate_10k<Tmin| cluster_medium_inf_datafull$infection_rate_10k>Tmax)
#cleaned data
cleaned_data<- subset(cluster_medium_inf_datafull,cluster_medium_inf_datafull$infection_rate_10k>Tmin & cluster_medium_inf_datafull$infection_rate_10k<Tmax)
#normality test
shapiro.test(cleaned_data$infection_rate_10k)

#summary(cleaned_data$infection_rate_10k)
#Normalize data(since data is not normally distributed we cannot use z score)
#cleaned_data$normalized_infection_rate_10k<- (cleaned_data$infection_rate_10k-63.17)/(321.49-63.17)

#(But fitting NB model to a standardized data doesn't make any sense.Therefore we decided to fit a model after removing outliers)

#Now I fit the NB model for infection_rate_10k in cleaned data

#convert infection rate into integers
cleaned_data$infection_rate_10k_integer<-round(cleaned_data$infection_rate_10k,digits = 0)

#split data set into training and testing
#make this example reproducible
set.seed(1)

#use 70% of dataset as training set and 30% as test set
sample <- sample(c(TRUE, FALSE), nrow(cleaned_data), replace=TRUE, prob=c(0.8,0.2))
train  <- cleaned_data[sample, ]
test   <- cleaned_data[!sample, ]

#fit NB model to training set
summary(m1 <- glm.nb(infection_rate_10k_integer~popdense+ageab65+pctpov+pctmale+pctwhite+pctblack+pcthispanic+pct_highschool_or_less+pct_Adults_with_Diabetes+pct_Adults_with_Obesity,data = train))
vif(m1)

summary(m1 <- glm.nb(infection_rate_10k_integer~popdense+ageab65+pctpov+pctmale+pctblack+pcthispanic+pct_highschool_or_less+pct_Adults_with_Diabetes+pct_Adults_with_Obesity,data = train))
vif(m1)


#RMSE for train data
#create new data set using independent varaibles
train_predict<- subset(train, select = -c(infection_rate_10k_integer))
#predict usin fitted NB 
train$predict_infection<- predict(m1, train_predict,type ="response")
rmse_train<-rmse(train$infection_rate_10k_integer,train$predict_infection)
rmse_train

#Normalized RMSE train
Normalized_rmse_train<- rmse_train/mean(train$infection_rate_10k_integer)
Normalized_rmse_train


#RMSE for test data
test_predict<- subset(test, select = -c(infection_rate_10k_integer))
test$predict_infection<- predict(m1, test_predict,type = "response")
rmse_test<- rmse(test$infection_rate_10k_integer,test$predict_infection)
rmse_test


#Normalized RMSE test
Normalized_rmse_test<- rmse_test/mean(test$infection_rate_10k_integer)
Normalized_rmse_test
```

#All year low infection model 9
```{r}
#Removing outliers
summary(cluster_low_inf_datafull$infection_rate_10k)
iqr<-IQR(cluster_low_inf_datafull$infection_rate_10k)
Tmax = 439.25+3*iqr #consider extreme outlires
Tmin = 281.90 -3*iqr #consider extreme outlires
#outliers
outl<- subset(cluster_low_inf_datafull,cluster_low_inf_datafull$infection_rate_10k<Tmin| cluster_low_inf_datafull$infection_rate_10k>Tmax)
#cleaned data
cleaned_data<- subset(cluster_low_inf_datafull,cluster_low_inf_datafull$infection_rate_10k>Tmin & cluster_low_inf_datafull$infection_rate_10k<Tmax)
#normality test
shapiro.test(cleaned_data$infection_rate_10k)

#summary(cleaned_data$infection_rate_10k)
#Normalize data(since data is not normally distributed we cannot use z score)
#cleaned_data$normalized_infection_rate_10k<- (cleaned_data$infection_rate_10k-63.17)/(321.49-63.17)

#(But fitting NB model to a standardized data doesn't make any sense.Therefore we decided to fit a model after removing outliers)

#Now I fit the NB model for infection_rate_10k in cleaned data

#convert infection rate into integers
cleaned_data$infection_rate_10k_integer<-round(cleaned_data$infection_rate_10k,digits = 0)

#split data set into training and testing
#make this example reproducible
set.seed(1)

#use 70% of dataset as training set and 30% as test set
sample <- sample(c(TRUE, FALSE), nrow(cleaned_data), replace=TRUE, prob=c(0.8,0.2))
train  <- cleaned_data[sample, ]
test   <- cleaned_data[!sample, ]

#fit NB model to training set
summary(m1 <- glm.nb(infection_rate_10k_integer~popdense+ageab65+pctpov+pctmale+pctwhite+pctblack+pcthispanic+pct_highschool_or_less+pct_Adults_with_Diabetes+pct_Adults_with_Obesity,data = train))
vif(m1)

summary(m1 <- glm.nb(infection_rate_10k_integer~popdense+ageab65+pctpov+pctmale+pctblack+pcthispanic+pct_highschool_or_less+pct_Adults_with_Diabetes+pct_Adults_with_Obesity,data = train))
vif(m1)


#RMSE for train data
#create new data set using independent varaibles
train_predict<- subset(train, select = -c(infection_rate_10k_integer))
#predict usin fitted NB 
train$predict_infection<- predict(m1, train_predict,type ="response")
rmse_train<-rmse(train$infection_rate_10k_integer,train$predict_infection)
rmse_train

#Normalized RMSE train
Normalized_rmse_train<- rmse_train/mean(train$infection_rate_10k_integer)
Normalized_rmse_train


#RMSE for test data
test_predict<- subset(test, select = -c(infection_rate_10k_integer))
test$predict_infection<- predict(m1, test_predict,type = "response")
rmse_test<- rmse(test$infection_rate_10k_integer,test$predict_infection)
rmse_test


#Normalized RMSE test
Normalized_rmse_test<- rmse_test/mean(test$infection_rate_10k_integer)
Normalized_rmse_test
```

##############################################
Interaction effect for Infection rate clusters
##############################################


#Phase 2 medium infection model 5(This one found as a good models using NRMSE)
```{r}
#Removing outliers
summary(cluster_medium_inf_dataphase2$infection_rate_10k)
iqr<-IQR(cluster_medium_inf_dataphase2$infection_rate_10k)
Tmax = 672.4+3*iqr #consider extreme outlires
Tmin = 526.0-3*iqr #consider extreme outlires
#outliers
outl<- subset(cluster_medium_inf_dataphase2,cluster_medium_inf_dataphase2$infection_rate_10k<Tmin| cluster_medium_inf_dataphase2$infection_rate_10k>Tmax)
#cleaned data
cleaned_data<- subset(cluster_medium_inf_dataphase2,cluster_medium_inf_dataphase2$infection_rate_10k>Tmin & cluster_medium_inf_dataphase2$infection_rate_10k<Tmax)
#normality test
shapiro.test(cleaned_data$infection_rate_10k)

#summary(cleaned_data$infection_rate_10k)
#Normalize data(since data is not normally distributed we cannot use z score)
#cleaned_data$normalized_infection_rate_10k<- (cleaned_data$infection_rate_10k-63.17)/(321.49-63.17)

#(But fitting NB model to a standardized data doesn't make any sense.Therefore we decided to fit a model after removing outliers)

#Now I fit the NB model for infection_rate_10k in cleaned data

#convert infection rate into integers
cleaned_data$infection_rate_10k_integer<-round(cleaned_data$infection_rate_10k,digits = 0)

#split data set into training and testing
#make this example reproducible
set.seed(1)

#use 80% of dataset as training set and 20% as test set
sample <- sample(c(TRUE, FALSE), nrow(cleaned_data), replace=TRUE, prob=c(0.8,0.2))
train  <- cleaned_data[sample, ]
test   <- cleaned_data[!sample, ]

#fit NB model to training set
summary(m1 <- glm.nb(infection_rate_10k_integer~popdense+ageab65+pctpov+pctmale+pctwhite+pctblack+pcthispanic+pct_highschool_or_less+pct_Adults_with_Diabetes+pct_Adults_with_Obesity,data = train))
vif(m1)

summary(m1 <- glm.nb(infection_rate_10k_integer~popdense+ageab65+pctpov+pctmale+pctblack+pcthispanic+pct_highschool_or_less+pct_Adults_with_Diabetes+pct_Adults_with_Obesity,data = train))
vif(m1)

#model only considering significant varaiables
summary(m1 <- glm.nb(infection_rate_10k_integer~popdense+ageab65+pctpov,data = train))
vif(m1)

#with Interaction effect(Uncentered)
summary(m1 <- glm.nb(infection_rate_10k_integer~popdense+ageab65+pctblack+popdense*ageab65+popdense*pctblack+ageab65*pctblack,data = train))
#multi-collinearity
vif(m1)


#with Interaction effect(Uncentered)- consider all the varaibles for the analysis
summary(m1 <- glm.nb(infection_rate_10k_integer~popdense+ageab65+pctpov+pctmale+pct_highschool_or_less+pct_Adults_with_Diabetes+pct_Adults_with_Obesity + pctblack+pcthispanic + 
                       popdense*ageab65 + popdense*pctpov + popdense*pctmale+ popdense*pct_highschool_or_less + popdense * pct_Adults_with_Diabetes + popdense* pct_Adults_with_Obesity + 
                       ageab65*pctpov+ ageab65*pctmale +ageab65* pct_highschool_or_less+ ageab65* pct_Adults_with_Diabetes + ageab65 *pct_Adults_with_Obesity + 
                       pctpov*pctmale + pctpov*pct_highschool_or_less + pctpov *pct_Adults_with_Diabetes + pctpov*pct_Adults_with_Obesity + 
                       pctmale* pct_highschool_or_less + pctmale * pct_Adults_with_Diabetes + pctmale* pct_Adults_with_Obesity + 
                       pct_highschool_or_less * pct_Adults_with_Diabetes + pct_highschool_or_less * pct_Adults_with_Obesity + 
                       pct_Adults_with_Diabetes * pct_Adults_with_Obesity +
                       
                       pctblack*popdense+pctblack*ageab65+pctblack*pctpov+pctblack*pctmale+pctblack*pct_highschool_or_less+pctblack*pct_Adults_with_Diabetes+pctblack*pct_Adults_with_Obesity +
                       
                       pcthispanic*popdense+pcthispanic*ageab65+pcthispanic*pctpov+pcthispanic*pctmale+pcthispanic*pct_highschool_or_less+pcthispanic*pct_Adults_with_Diabetes+pcthispanic*pct_Adults_with_Obesity + pcthispanic*pctblack,data = train))

#RMSE for train data
#create new data set using independent varaibles
train_predict<- subset(train, select = -c(infection_rate_10k_integer))
#predict usin fitted NB 
train$predict_infection<- predict(m1, train_predict,type ="response")
rmse_train<-rmse(train$infection_rate_10k_integer,train$predict_infection)
rmse_train

#Normalized RMSE train
Normalized_rmse_train<- rmse_train/mean(train$infection_rate_10k_integer)
Normalized_rmse_train


#RMSE for test data
test_predict<- subset(test, select = -c(infection_rate_10k_integer))
test$predict_infection<- predict(m1, test_predict,type = "response")
rmse_test<- rmse(test$infection_rate_10k_integer,test$predict_infection)
rmse_test


#Normalized RMSE test
Normalized_rmse_test<- rmse_test/mean(test$infection_rate_10k_integer)
Normalized_rmse_test

#Go back to the original model with interaction terms(tried to improve the model but couldn't)
summary(m1 <- glm.nb(infection_rate_10k_integer~popdense+ageab65+pctpov+pctmale+pct_highschool_or_less+pct_Adults_with_Diabetes+pct_Adults_with_Obesity+popdense*ageab65+popdense*pctpov+ageab65*pctpov,data = train))
vif(m1)

#RMSE for train data
#create new data set using independent varaibles
train_predict<- subset(train, select = -c(infection_rate_10k_integer))
#predict usin fitted NB 
train$predict_infection<- predict(m1, train_predict,type ="response")
rmse_train<-rmse(train$infection_rate_10k_integer,train$predict_infection)
rmse_train

#Normalized RMSE train
Normalized_rmse_train<- rmse_train/mean(train$infection_rate_10k_integer)
Normalized_rmse_train


#RMSE for test data
test_predict<- subset(test, select = -c(infection_rate_10k_integer))
test$predict_infection<- predict(m1, test_predict,type = "response")
rmse_test<- rmse(test$infection_rate_10k_integer,test$predict_infection)
rmse_test


#Normalized RMSE test
Normalized_rmse_test<- rmse_test/mean(test$infection_rate_10k_integer)
Normalized_rmse_test

#Furthermore, try to improve model considering variables that are not actually significant in the model but close to be significnat.

#original model again
summary(m1 <- glm.nb(infection_rate_10k_integer~popdense+ageab65+pctpov+pctmale+pct_highschool_or_less+pct_Adults_with_Diabetes+pct_Adults_with_Obesity,data = train))
vif(m1)
#in this case there is no such a variable


##################
#center predictors
#################

#with Interaction effect(Uncentered)
summary(m1 <- glm.nb(infection_rate_10k_integer~popdense+ageab65+pctpov+popdense*ageab65+popdense*pctpov+ageab65*pctpov,data = train))
#multi-collinearity
vif(m1)

cor.test(train$popdense, train$popdense*train$ageab65)
cor.test(train$popdense, train$popdense*train$pctpov)
cor.test(train$popdense, train$popdense*train$pctpov)


#we can center predictors for both train and testing tests
train$popdense_cent<- train$popdense - mean(train$popdense)
train$ageab65_cent<- train$ageab65 - mean(train$ageab65)
train$pctpov_cent<- train$pctpov - mean(train$pctpov)

test$popdense_cent<- test$popdense - mean(train$popdense)
test$ageab65_cent<- test$ageab65 - mean(train$ageab65)
test$pctpov_cent<- test$pctpov - mean(train$pctpov)

#now let's check with interaction for centered data
#with interaction(centered)
summary(m1 <- glm.nb(infection_rate_10k_integer~popdense_cent+ageab65_cent+pctpov_cent+popdense_cent*ageab65_cent+popdense_cent*pctpov_cent+ageab65_cent*pctpov_cent,data = train))
#multi-collinearity
vif(m1)

#want to show if main effect(without interaction) is same for centered and uncentered data
#now let's check this with centered predictors for main effect
#summary(m1 <- glm.nb(infection_rate_10k_integer~popdense_cent+ageab65_cent+pctpov_cent+pctmale+pct_highschool_or_less+pct_Adults_with_Diabetes+pct_Adults_with_Obesity,data = train))
#vif(m1)

#compare with original model*following is the original model)
#summary(m1 <- glm.nb(infection_rate_10k_integer~popdense+ageab65+pctpov+pctmale+pct_highschool_or_less+pct_Adults_with_Diabetes+pct_Adults_with_Obesity,data = train))
#vif(m1)


#RMSE for train data
#create new data set using independent varaibles
train_predict<- subset(train, select = -c(infection_rate_10k_integer))
#predict usin fitted NB 
train$predict_infection<- predict(m1, train_predict,type ="response")
rmse_train<-rmse(train$infection_rate_10k_integer,train$predict_infection)
rmse_train

#Normalized RMSE train
Normalized_rmse_train<- rmse_train/mean(train$infection_rate_10k_integer)
Normalized_rmse_train


#RMSE for test data
test_predict<- subset(test, select = -c(infection_rate_10k_integer))
test$predict_infection<- predict(m1, test_predict,type = "response")
rmse_test<- rmse(test$infection_rate_10k_integer,test$predict_infection)
rmse_test


#Normalized RMSE test
Normalized_rmse_test<- rmse_test/mean(test$infection_rate_10k_integer)
Normalized_rmse_test

```

#Phase 2 high infection model 4(This one found as a good models using NRMSE)
```{r}
#Removing outliers
summary(cluster_high_inf_dataphase2$infection_rate_10k)
iqr<-IQR(cluster_high_inf_dataphase2$infection_rate_10k)
Tmax = 1006.8+3*iqr #consider extreme outlires
Tmin = 815.2-3*iqr #consider extreme outlires
#outliers
outl<- subset(cluster_high_inf_dataphase2,cluster_high_inf_dataphase2$infection_rate_10k<Tmin| cluster_high_inf_dataphase2$infection_rate_10k>Tmax)
#cleaned data
cleaned_data<- subset(cluster_high_inf_dataphase2,cluster_high_inf_dataphase2$infection_rate_10k>Tmin & cluster_high_inf_dataphase2$infection_rate_10k<Tmax)
#normality test
shapiro.test(cleaned_data$infection_rate_10k)

#summary(cleaned_data$infection_rate_10k)
#Normalize data(since data is not normally distributed we cannot use z score)
#cleaned_data$normalized_infection_rate_10k<- (cleaned_data$infection_rate_10k-63.17)/(321.49-63.17)

#(But fitting NB model to a standardized data doesn't make any sense.Therefore we decided to fit a model after removing outliers)

#Now I fit the NB model for infection_rate_10k in cleaned data

#convert infection rate into integers
cleaned_data$infection_rate_10k_integer<-round(cleaned_data$infection_rate_10k,digits = 0)

#split data set into training and testing
#make this example reproducible
set.seed(1)

#use 70% of dataset as training set and 30% as test set
sample <- sample(c(TRUE, FALSE), nrow(cleaned_data), replace=TRUE, prob=c(0.8,0.2))
train  <- cleaned_data[sample, ]
test   <- cleaned_data[!sample, ]

#fit NB model to training set
summary(m1 <- glm.nb(infection_rate_10k_integer~popdense+ageab65+pctpov+pctmale+pctwhite+pctblack+pcthispanic+pct_highschool_or_less+pct_Adults_with_Diabetes+pct_Adults_with_Obesity,data = train))
vif(m1)

summary(m1 <- glm.nb(infection_rate_10k_integer~popdense+ageab65+pctpov+pctmale+pctblack+pcthispanic+pct_highschool_or_less+pct_Adults_with_Diabetes+pct_Adults_with_Obesity,data = train))
vif(m1)



#with Interaction effect(Uncentered)- consider all the varaibles for the analysis
summary(m1 <- glm.nb(infection_rate_10k_integer~popdense+ageab65+pctpov+pctmale+pct_highschool_or_less+pct_Adults_with_Diabetes+pct_Adults_with_Obesity + pctblack+pcthispanic + 
                       popdense*ageab65 + popdense*pctpov + popdense*pctmale+ popdense*pct_highschool_or_less + popdense * pct_Adults_with_Diabetes + popdense* pct_Adults_with_Obesity + 
                       ageab65*pctpov+ ageab65*pctmale +ageab65* pct_highschool_or_less+ ageab65* pct_Adults_with_Diabetes + ageab65 *pct_Adults_with_Obesity + 
                       pctpov*pctmale + pctpov*pct_highschool_or_less + pctpov *pct_Adults_with_Diabetes + pctpov*pct_Adults_with_Obesity + 
                       pctmale* pct_highschool_or_less + pctmale * pct_Adults_with_Diabetes + pctmale* pct_Adults_with_Obesity + 
                       pct_highschool_or_less * pct_Adults_with_Diabetes + pct_highschool_or_less * pct_Adults_with_Obesity + 
                       pct_Adults_with_Diabetes * pct_Adults_with_Obesity +
                       
                       pctblack*popdense+pctblack*ageab65+pctblack*pctpov+pctblack*pctmale+pctblack*pct_highschool_or_less+pctblack*pct_Adults_with_Diabetes+pctblack*pct_Adults_with_Obesity +
                       
                       pcthispanic*popdense+pcthispanic*ageab65+pcthispanic*pctpov+pcthispanic*pctmale+pcthispanic*pct_highschool_or_less+pcthispanic*pct_Adults_with_Diabetes+pcthispanic*pct_Adults_with_Obesity + pcthispanic*pctblack,data = train))





#model only with significant varaibles
summary(m1 <- glm.nb(infection_rate_10k_integer~pctmale+pctblack,data = train))
vif(m1)

#with interaction
summary(m1 <- glm.nb(infection_rate_10k_integer~pctmale+pctblack+pctmale*pctblack,data = train))

#with Interaction effect(Uncentered)- consider all the varaibles for the analysis
summary(m1 <- glm.nb(infection_rate_10k_integer~popdense+ageab65+pctpov+pctmale+pct_highschool_or_less+pct_Adults_with_Diabetes+pct_Adults_with_Obesity + pctblack + popdense*ageab65 + popdense*pctpov + popdense*pctmale+ popdense*pct_highschool_or_less + popdense * pct_Adults_with_Diabetes + popdense* pct_Adults_with_Obesity + ageab65*pctpov+ ageab65*pctmale +ageab65* pct_highschool_or_less+ ageab65* pct_Adults_with_Diabetes + ageab65 *pct_Adults_with_Obesity + pctpov*pctmale + pctpov*pct_highschool_or_less + pctpov *pct_Adults_with_Diabetes + pctpov*pct_Adults_with_Obesity + pctmale* pct_highschool_or_less + pctmale * pct_Adults_with_Diabetes + pctmale* pct_Adults_with_Obesity + pct_highschool_or_less * pct_Adults_with_Diabetes + pct_highschool_or_less * pct_Adults_with_Obesity + pct_Adults_with_Diabetes * pct_Adults_with_Obesity +
                       pctblack*popdense+pctblack*ageab65+pctblack*pctpov+pctblack*pctmale+pctblack*pct_highschool_or_less+pctblack*pct_Adults_with_Diabetes+pctblack*pct_Adults_with_Obesity +
                       pctwhite*popdense+pctwhite*ageab65+pctwhite*pctpov+pctwhite*pctmale+pctwhite*pct_highschool_or_less+pctwhite*pct_Adults_with_Diabetes+pctwhite*pct_Adults_with_Obesity + pctwhite*pctblack+
                       pcthispanic*popdense+pcthispanic*ageab65+pcthispanic*pctpov+pcthispanic*pctmale+pcthispanic*pct_highschool_or_less+pcthispanic*pct_Adults_with_Diabetes+pcthispanic*pct_Adults_with_Obesity + pcthispanic*pctblack,data = train))



#RMSE for train data
#create new data set using independent varaibles
train_predict<- subset(train, select = -c(infection_rate_10k_integer))
#predict usin fitted NB 
train$predict_infection<- predict(m1, train_predict,type ="response")
rmse_train<-rmse(train$infection_rate_10k_integer,train$predict_infection)
rmse_train

#Normalized RMSE train
Normalized_rmse_train<- rmse_train/mean(train$infection_rate_10k_integer)
Normalized_rmse_train


#RMSE for test data
test_predict<- subset(test, select = -c(infection_rate_10k_integer))
test$predict_infection<- predict(m1, test_predict,type = "response")
rmse_test<- rmse(test$infection_rate_10k_integer,test$predict_infection)
rmse_test


#Normalized RMSE test
Normalized_rmse_test<- rmse_test/mean(test$infection_rate_10k_integer)
Normalized_rmse_test

#check only interaction terms(still get the same answer as above)
#summary(m1 <- glm.nb(infection_rate_10k_integer~pctmale*pctblack,data = train))


#Go back to the original model with interaction terms(tried to improve the model but could't)
summary(m1 <- glm.nb(infection_rate_10k_integer~popdense+ageab65+pctpov+pctmale+pctblack+pct_highschool_or_less+pct_Adults_with_Diabetes+pct_Adults_with_Obesity+pctmale*pctblack,data = train))
vif(m1)



#RMSE for train data
#create new data set using independent varaibles
train_predict<- subset(train, select = -c(infection_rate_10k_integer))
#predict usin fitted NB 
train$predict_infection<- predict(m1, train_predict,type ="response")
rmse_train<-rmse(train$infection_rate_10k_integer,train$predict_infection)
rmse_train

#Normalized RMSE train
Normalized_rmse_train<- rmse_train/mean(train$infection_rate_10k_integer)
Normalized_rmse_train


#RMSE for test data
test_predict<- subset(test, select = -c(infection_rate_10k_integer))
test$predict_infection<- predict(m1, test_predict,type = "response")
rmse_test<- rmse(test$infection_rate_10k_integer,test$predict_infection)
rmse_test


#Normalized RMSE test
Normalized_rmse_test<- rmse_test/mean(test$infection_rate_10k_integer)
Normalized_rmse_test

#Furthermore, try to improve model considering variables that are not actually significant in the model but close to be significnat.

#original model again
summary(m1 <- glm.nb(infection_rate_10k_integer~popdense+ageab65+pctpov+pctmale+pctblack+pct_highschool_or_less+pct_Adults_with_Diabetes+pct_Adults_with_Obesity,data = train))
vif(m1)
#in this case we consider popdense and education
summary(m1 <- glm.nb(infection_rate_10k_integer~popdense+ageab65+pctpov+pctmale+pctblack+pct_highschool_or_less+pct_Adults_with_Diabetes+pct_Adults_with_Obesity+pctmale*pctblack+pctmale*popdense+pctmale*pct_highschool_or_less+pctblack*popdense+pctblack*pct_highschool_or_less,data = train))
vif(m1)

#RMSE for train data
#create new data set using independent varaibles
train_predict<- subset(train, select = -c(infection_rate_10k_integer))
#predict usin fitted NB 
train$predict_infection<- predict(m1, train_predict,type ="response")
rmse_train<-rmse(train$infection_rate_10k_integer,train$predict_infection)
rmse_train

#Normalized RMSE train
Normalized_rmse_train<- rmse_train/mean(train$infection_rate_10k_integer)
Normalized_rmse_train


#RMSE for test data
test_predict<- subset(test, select = -c(infection_rate_10k_integer))
test$predict_infection<- predict(m1, test_predict,type = "response")
rmse_test<- rmse(test$infection_rate_10k_integer,test$predict_infection)
rmse_test


#Normalized RMSE test
Normalized_rmse_test<- rmse_test/mean(test$infection_rate_10k_integer)
Normalized_rmse_test

##################
#center predictors
#################

#with Interaction effect(Uncentered)
summary(m1 <- glm.nb(infection_rate_10k_integer~pctmale+pctblack+pctmale*pctblack,data = train))
#multi-collinearity
vif(m1)

cor.test(train$pctmale, train$pctmale*train$pctblack)
cor.test(train$pctblack, train$pctmale*train$pctblack)



#we can center predictors for both train and testing tests
train$pctmale_cent<- train$pctmale - mean(train$pctmale)
train$pctblack_cent<- train$pctblack - mean(train$pctblack)

test$pctmale_cent<- test$pctmale - mean(test$pctmale)
test$pctblack_cent<- test$pctblack - mean(test$pctblack)


#now let's check with interaction for centered data
#with interaction(centered)
summary(m1 <- glm.nb(infection_rate_10k_integer~pctmale_cent+pctblack_cent+pctmale_cent*pctblack_cent,data = train))
#multi-collinearity
vif(m1)

#RMSE for train data
#create new data set using independent varaibles
train_predict<- subset(train, select = -c(infection_rate_10k_integer))
#predict usin fitted NB 
train$predict_infection<- predict(m1, train_predict,type ="response")
rmse_train<-rmse(train$infection_rate_10k_integer,train$predict_infection)
rmse_train

#Normalized RMSE train
Normalized_rmse_train<- rmse_train/mean(train$infection_rate_10k_integer)
Normalized_rmse_train


#RMSE for test data
test_predict<- subset(test, select = -c(infection_rate_10k_integer))
test$predict_infection<- predict(m1, test_predict,type = "response")
rmse_test<- rmse(test$infection_rate_10k_integer,test$predict_infection)
rmse_test


#Normalized RMSE test
Normalized_rmse_test<- rmse_test/mean(test$infection_rate_10k_integer)
Normalized_rmse_test
```

#All year medium infection model 8(this one is good from rmse)
```{r}
#Removing outliers
summary(cluster_medium_inf_datafull$infection_rate_10k)
iqr<-IQR(cluster_medium_inf_datafull$infection_rate_10k)
Tmax = 724.5+3*iqr #consider extreme outlires
Tmin = 577.1 -3*iqr #consider extreme outlires
#outliers
outl<- subset(cluster_medium_inf_datafull,cluster_medium_inf_datafull$infection_rate_10k<Tmin| cluster_medium_inf_datafull$infection_rate_10k>Tmax)
#cleaned data
cleaned_data<- subset(cluster_medium_inf_datafull,cluster_medium_inf_datafull$infection_rate_10k>Tmin & cluster_medium_inf_datafull$infection_rate_10k<Tmax)
#normality test
shapiro.test(cleaned_data$infection_rate_10k)

#summary(cleaned_data$infection_rate_10k)
#Normalize data(since data is not normally distributed we cannot use z score)
#cleaned_data$normalized_infection_rate_10k<- (cleaned_data$infection_rate_10k-63.17)/(321.49-63.17)

#(But fitting NB model to a standardized data doesn't make any sense.Therefore we decided to fit a model after removing outliers)

#Now I fit the NB model for infection_rate_10k in cleaned data

#convert infection rate into integers
cleaned_data$infection_rate_10k_integer<-round(cleaned_data$infection_rate_10k,digits = 0)

#split data set into training and testing
#make this example reproducible
set.seed(1)

#use 70% of dataset as training set and 30% as test set
sample <- sample(c(TRUE, FALSE), nrow(cleaned_data), replace=TRUE, prob=c(0.8,0.2))
train  <- cleaned_data[sample, ]
test   <- cleaned_data[!sample, ]

#fit NB model to training set
summary(m1 <- glm.nb(infection_rate_10k_integer~popdense+ageab65+pctpov+pctmale+pctwhite+pctblack+pcthispanic+pct_highschool_or_less+pct_Adults_with_Diabetes+pct_Adults_with_Obesity,data = train))
vif(m1)

summary(m1 <- glm.nb(infection_rate_10k_integer~popdense+ageab65+pctpov+pctmale+pctblack+pcthispanic+pct_highschool_or_less+pct_Adults_with_Diabetes+pct_Adults_with_Obesity,data = train))
vif(m1)

#only with significant varaiables
summary(m1 <- glm.nb(infection_rate_10k_integer~popdense+ageab65,data = train))
vif(m1)

#with interaction
summary(m1 <- glm.nb(infection_rate_10k_integer~popdense+ageab65+popdense*ageab65,data = train))
vif(m1)


# consider all the variables with interaction for the analysis
summary(m1 <- glm.nb(infection_rate_10k_integer~popdense+ageab65+pctpov+pctmale+pct_highschool_or_less+pct_Adults_with_Diabetes+pct_Adults_with_Obesity + pctblack + popdense*ageab65 + popdense*pctpov + popdense*pctmale+ popdense*pct_highschool_or_less + popdense * pct_Adults_with_Diabetes + popdense* pct_Adults_with_Obesity + ageab65*pctpov+ ageab65*pctmale +ageab65* pct_highschool_or_less+ ageab65* pct_Adults_with_Diabetes + ageab65 *pct_Adults_with_Obesity + pctpov*pctmale + pctpov*pct_highschool_or_less + pctpov *pct_Adults_with_Diabetes + pctpov*pct_Adults_with_Obesity + pctmale* pct_highschool_or_less + pctmale * pct_Adults_with_Diabetes + pctmale* pct_Adults_with_Obesity + pct_highschool_or_less * pct_Adults_with_Diabetes + pct_highschool_or_less * pct_Adults_with_Obesity + pct_Adults_with_Diabetes * pct_Adults_with_Obesity +
                       pctblack*popdense+pctblack*ageab65+pctblack*pctpov+pctblack*pctmale+pctblack*pct_highschool_or_less+pctblack*pct_Adults_with_Diabetes+pctblack*pct_Adults_with_Obesity +
                       pctwhite*popdense+pctwhite*ageab65+pctwhite*pctpov+pctwhite*pctmale+pctwhite*pct_highschool_or_less+pctwhite*pct_Adults_with_Diabetes+pctwhite*pct_Adults_with_Obesity + pctwhite*pctblack+
                       pcthispanic*popdense+pcthispanic*ageab65+pcthispanic*pctpov+pcthispanic*pctmale+pcthispanic*pct_highschool_or_less+pcthispanic*pct_Adults_with_Diabetes+pcthispanic*pct_Adults_with_Obesity + pcthispanic*pctblack,data = train))



#RMSE for train data
#create new data set using independent varaibles
train_predict<- subset(train, select = -c(infection_rate_10k_integer))
#predict usin fitted NB 
train$predict_infection<- predict(m1, train_predict,type ="response")
rmse_train<-rmse(train$infection_rate_10k_integer,train$predict_infection)
rmse_train

#Normalized RMSE train
Normalized_rmse_train<- rmse_train/mean(train$infection_rate_10k_integer)
Normalized_rmse_train


#RMSE for test data
test_predict<- subset(test, select = -c(infection_rate_10k_integer))
test$predict_infection<- predict(m1, test_predict,type = "response")
rmse_test<- rmse(test$infection_rate_10k_integer,test$predict_infection)
rmse_test


#Normalized RMSE test
Normalized_rmse_test<- rmse_test/mean(test$infection_rate_10k_integer)
Normalized_rmse_test


#Go back to the original model with interaction terms(tried to improve the model but could't)
summary(m1 <- glm.nb(infection_rate_10k_integer~popdense+ageab65+pctpov+pctmale+pct_highschool_or_less+pct_Adults_with_Diabetes+pct_Adults_with_Obesity+popdense*ageab65+popdense*pctpov+ageab65*pctpov,data = train))
vif(m1)

#RMSE for train data
#create new data set using independent varaibles
train_predict<- subset(train, select = -c(infection_rate_10k_integer))
#predict usin fitted NB 
train$predict_infection<- predict(m1, train_predict,type ="response")
rmse_train<-rmse(train$infection_rate_10k_integer,train$predict_infection)
rmse_train

#Normalized RMSE train
Normalized_rmse_train<- rmse_train/mean(train$infection_rate_10k_integer)
Normalized_rmse_train


#RMSE for test data
test_predict<- subset(test, select = -c(infection_rate_10k_integer))
test$predict_infection<- predict(m1, test_predict,type = "response")
rmse_test<- rmse(test$infection_rate_10k_integer,test$predict_infection)
rmse_test


#Normalized RMSE test
Normalized_rmse_test<- rmse_test/mean(test$infection_rate_10k_integer)
Normalized_rmse_test

#Furthermore, try to improve model considering variables that are not actually significant in the model but close to be significant.(there is no such a variable)

##################
#center predictors
#################

#with Interaction effect(Uncentered)
summary(m1 <- glm.nb(infection_rate_10k_integer~popdense+ageab65+popdense*ageab65,data = train))
#multi-collinearity
vif(m1)

cor.test(train$popdense, train$popdense*train$ageab65)
cor.test(train$ageab65, train$popdense*train$ageab65)


#we can center predictors for both train and testing tests
train$popdense_cent<- train$popdense - mean(train$popdense)
train$ageab65_cent<- train$ageab65 - mean(train$ageab65)

test$popdense_cent<- test$popdense - mean(test$popdense)
test$ageab65_cent<- test$ageab65 - mean(test$ageab65)


#now let's check with interaction for centered data
#with interaction(centered)
summary(m1 <- glm.nb(infection_rate_10k_integer~popdense_cent+ageab65_cent+popdense_cent*ageab65_cent,data = train))
#multi-collinearity
vif(m1)

#RMSE for train data
#create new data set using independent varaibles
train_predict<- subset(train, select = -c(infection_rate_10k_integer))
#predict usin fitted NB 
train$predict_infection<- predict(m1, train_predict,type ="response")
rmse_train<-rmse(train$infection_rate_10k_integer,train$predict_infection)
rmse_train

#Normalized RMSE train
Normalized_rmse_train<- rmse_train/mean(train$infection_rate_10k_integer)
Normalized_rmse_train


#RMSE for test data
test_predict<- subset(test, select = -c(infection_rate_10k_integer))
test$predict_infection<- predict(m1, test_predict,type = "response")
rmse_test<- rmse(test$infection_rate_10k_integer,test$predict_infection)
rmse_test


#Normalized RMSE test
Normalized_rmse_test<- rmse_test/mean(test$infection_rate_10k_integer)
Normalized_rmse_test
```

#All year high infection model 7(this is good one based on rmse)
```{r}
#Removing outliers
summary(cluster_high_inf_datafull$infection_rate_10k)
iqr<-IQR(cluster_high_inf_datafull$infection_rate_10k)
Tmax = 1082.3+3*iqr #consider extreme outlires
Tmin = 876.1 -3*iqr #consider extreme outlires
#outliers
outl<- subset(cluster_high_inf_datafull,cluster_high_inf_datafull$infection_rate_10k<Tmin| cluster_high_inf_datafull$infection_rate_10k>Tmax)
#cleaned data
cleaned_data<- subset(cluster_high_inf_datafull,cluster_high_inf_datafull$infection_rate_10k>Tmin & cluster_high_inf_datafull$infection_rate_10k<Tmax)
#normality test
shapiro.test(cleaned_data$infection_rate_10k)

#summary(cleaned_data$infection_rate_10k)
#Normalize data(since data is not normally distributed we cannot use z score)
#cleaned_data$normalized_infection_rate_10k<- (cleaned_data$infection_rate_10k-63.17)/(321.49-63.17)

#(But fitting NB model to a standardized data doesn't make any sense.Therefore we decided to fit a model after removing outliers)

#Now I fit the NB model for infection_rate_10k in cleaned data

#convert infection rate into integers
cleaned_data$infection_rate_10k_integer<-round(cleaned_data$infection_rate_10k,digits = 0)

#split data set into training and testing
#make this example reproducible
set.seed(1)

#use 70% of dataset as training set and 30% as test set
sample <- sample(c(TRUE, FALSE), nrow(cleaned_data), replace=TRUE, prob=c(0.8,0.2))
train  <- cleaned_data[sample, ]
test   <- cleaned_data[!sample, ]

#fit NB model to training set
summary(m1 <- glm.nb(infection_rate_10k_integer~popdense+ageab65+pctpov+pctmale+pctwhite+pctblack+pcthispanic+pct_highschool_or_less+pct_Adults_with_Diabetes+pct_Adults_with_Obesity,data = train))
vif(m1)

summary(m1 <- glm.nb(infection_rate_10k_integer~popdense+ageab65+pctpov+pctmale+pctblack+pcthispanic+pct_highschool_or_less+pct_Adults_with_Diabetes+pct_Adults_with_Obesity,data = train))
vif(m1)

#only with significant varaiables
summary(m1 <- glm.nb(infection_rate_10k_integer~popdense+pctpov+pctmale+pctblack+pct_highschool_or_less+pct_Adults_with_Diabetes,data = train))
vif(m1)

#with interaction effect
summary(m1 <- glm.nb(infection_rate_10k_integer~popdense+pctpov+pctmale+pctblack+pct_highschool_or_less+pct_Adults_with_Diabetes+popdense*pctpov+popdense*pctmale+popdense*pctblack+popdense*pct_highschool_or_less+popdense*pct_Adults_with_Diabetes+pctpov*pctmale+pctpov*pctblack+pctpov*pct_highschool_or_less+pctpov*pct_Adults_with_Diabetes+pctmale*pctblack+pctmale*pct_highschool_or_less+pctmale*pct_Adults_with_Diabetes+pctblack*pct_highschool_or_less+pctblack*pct_Adults_with_Diabetes+pct_highschool_or_less*pct_Adults_with_Diabetes,data = train))


#RMSE for train data
#create new data set using independent varaibles
train_predict<- subset(train, select = -c(infection_rate_10k_integer))
#predict usin fitted NB 
train$predict_infection<- predict(m1, train_predict,type ="response")
rmse_train<-rmse(train$infection_rate_10k_integer,train$predict_infection)
rmse_train

#Normalized RMSE train
Normalized_rmse_train<- rmse_train/mean(train$infection_rate_10k_integer)
Normalized_rmse_train


#RMSE for test data
test_predict<- subset(test, select = -c(infection_rate_10k_integer))
test$predict_infection<- predict(m1, test_predict,type = "response")
rmse_test<- rmse(test$infection_rate_10k_integer,test$predict_infection)
rmse_test


#Normalized RMSE test
Normalized_rmse_test<- rmse_test/mean(test$infection_rate_10k_integer)
Normalized_rmse_test

#check only interaction terms(still get the same answer as above)
summary(m1 <- glm.nb(infection_rate_10k_integer~popdense*pctpov+popdense*pctmale+popdense*pctblack+popdense*pct_highschool_or_less+popdense*pct_Adults_with_Diabetes+pctpov*pctmale+pctpov*pctblack+pctpov*pct_highschool_or_less+pctpov*pct_Adults_with_Diabetes+pctmale*pctblack+pctmale*pct_highschool_or_less+pctmale*pct_Adults_with_Diabetes+pctblack*pct_highschool_or_less+pctblack*pct_Adults_with_Diabetes+pct_highschool_or_less*pct_Adults_with_Diabetes,data = train))


#Go back to the original model with interaction terms(tried to improve the model but could't)
summary(m1 <- glm.nb(infection_rate_10k_integer~popdense+ageab65+pctpov+pctmale+pctblack+pcthispanic+pct_highschool_or_less+pct_Adults_with_Diabetes+pct_Adults_with_Obesity+popdense*pctpov+popdense*pctmale+popdense*pctblack+popdense*pct_highschool_or_less+popdense*pct_Adults_with_Diabetes+pctpov*pctmale+pctpov*pctblack+pctpov*pct_highschool_or_less+pctpov*pct_Adults_with_Diabetes+pctmale*pctblack+pctmale*pct_highschool_or_less+pctmale*pct_Adults_with_Diabetes+pctblack*pct_highschool_or_less+pctblack*pct_Adults_with_Diabetes+pct_highschool_or_less*pct_Adults_with_Diabetes,data = train))
vif(m1)

#RMSE for train data
#create new data set using independent varaibles
train_predict<- subset(train, select = -c(infection_rate_10k_integer))
#predict usin fitted NB 
train$predict_infection<- predict(m1, train_predict,type ="response")
rmse_train<-rmse(train$infection_rate_10k_integer,train$predict_infection)
rmse_train

#Normalized RMSE train
Normalized_rmse_train<- rmse_train/mean(train$infection_rate_10k_integer)
Normalized_rmse_train


#RMSE for test data
test_predict<- subset(test, select = -c(infection_rate_10k_integer))
test$predict_infection<- predict(m1, test_predict,type = "response")
rmse_test<- rmse(test$infection_rate_10k_integer,test$predict_infection)
rmse_test


#Normalized RMSE test
Normalized_rmse_test<- rmse_test/mean(test$infection_rate_10k_integer)
Normalized_rmse_test

#Furthermore, try to improve model considering variables that are not actually significant in the model but close to be significnat.

#original model again
summary(m1 <- glm.nb(infection_rate_10k_integer~popdense+ageab65+pctpov+pctmale+pctblack+pcthispanic+pct_highschool_or_less+pct_Adults_with_Diabetes+pct_Adults_with_Obesity,data = train))
vif(m1)
#in this case we consider pct_Adults_with_Obesity
summary(m1 <- glm.nb(infection_rate_10k_integer~popdense+pctpov+pctmale+pctblack+pct_highschool_or_less+pct_Adults_with_Diabetes+popdense*pctpov+popdense*pctmale+popdense*pctblack+popdense*pct_highschool_or_less+popdense*pct_Adults_with_Diabetes+pctpov*pctmale+pctpov*pctblack+pctpov*pct_highschool_or_less+pctpov*pct_Adults_with_Diabetes+pctmale*pctblack+pctmale*pct_highschool_or_less+pctmale*pct_Adults_with_Diabetes+pctblack*pct_highschool_or_less+pctblack*pct_Adults_with_Diabetes+pct_highschool_or_less*pct_Adults_with_Diabetes+pct_Adults_with_Obesity+pct_Adults_with_Obesity*popdense+pct_Adults_with_Obesity*pctpov+pct_Adults_with_Obesity*pctmale+pct_Adults_with_Obesity*pctblack+pct_Adults_with_Obesity*pct_highschool_or_less+pct_Adults_with_Obesity*pct_Adults_with_Diabetes,data = train))

#RMSE for train data
#create new data set using independent varaibles
train_predict<- subset(train, select = -c(infection_rate_10k_integer))
#predict usin fitted NB 
train$predict_infection<- predict(m1, train_predict,type ="response")
rmse_train<-rmse(train$infection_rate_10k_integer,train$predict_infection)
rmse_train

#Normalized RMSE train
Normalized_rmse_train<- rmse_train/mean(train$infection_rate_10k_integer)
Normalized_rmse_train


#RMSE for test data
test_predict<- subset(test, select = -c(infection_rate_10k_integer))
test$predict_infection<- predict(m1, test_predict,type = "response")
rmse_test<- rmse(test$infection_rate_10k_integer,test$predict_infection)
rmse_test


#Normalized RMSE test
Normalized_rmse_test<- rmse_test/mean(test$infection_rate_10k_integer)
Normalized_rmse_test

##################
#center predictors
#################

#with Interaction effect(Uncentered)
summary(m1 <- glm.nb(infection_rate_10k_integer~popdense+pctpov+pctmale+pctblack+pct_highschool_or_less+pct_Adults_with_Diabetes
                     +popdense*pctpov+popdense*pctmale+popdense*pctblack+popdense*pct_highschool_or_less+popdense*pct_Adults_with_Diabetes+pctpov*pctmale+pctpov*pctblack+pctpov*pct_highschool_or_less+pctpov*pct_Adults_with_Diabetes+pctmale*pctblack+pctmale*pct_highschool_or_less+pctmale*pct_Adults_with_Diabetes+pctblack*pct_highschool_or_less+pctblack*pct_Adults_with_Diabetes+pct_highschool_or_less*pct_Adults_with_Diabetes,data = train))
#multi-collinearity
vif(m1)

#we can center predictors for both train and testing tests
train$popdense_cent<- train$popdense - mean(train$popdense)
train$pctpov_cent<- train$pctpov - mean(train$pctpov)
train$pctmale_cent<- train$pctmale - mean(train$pctmale)
train$pctblack_cent<- train$pctblack - mean(train$pctblack)
train$pct_highschool_or_less_cent<- train$pct_highschool_or_less - mean(train$pct_highschool_or_less)
train$pct_Adults_with_Diabetes_cent<- train$pct_Adults_with_Diabetes - mean(train$pct_Adults_with_Diabetes)

test$popdense_cent<- test$popdense - mean(test$popdense)
test$pctpov_cent<- test$pctpov - mean(test$pctpov)
test$pctmale_cent<- test$pctmale - mean(test$pctmale)
test$pctblack_cent<- test$pctblack - mean(test$pctblack)
test$pct_highschool_or_less_cent<- test$pct_highschool_or_less - mean(test$pct_highschool_or_less)
test$pct_Adults_with_Diabetes_cent<- test$pct_Adults_with_Diabetes - mean(test$pct_Adults_with_Diabetes)

#now let's check with interaction for centered data
#with interaction(centered)
summary(m1 <- glm.nb(infection_rate_10k_integer~popdense_cent+pctpov_cent+pctmale_cent+pctblack_cent+pct_highschool_or_less_cent+pct_Adults_with_Diabetes_cent
                     +popdense_cent*pctpov_cent+popdense_cent*pctmale_cent+popdense_cent*pctblack_cent+popdense_cent*pct_highschool_or_less_cent+popdense_cent*pct_Adults_with_Diabetes_cent+pctpov_cent*pctmale_cent+pctpov_cent*pctblack_cent+pctpov_cent*pct_highschool_or_less_cent+pctpov_cent*pct_Adults_with_Diabetes_cent+pctmale_cent*pctblack_cent+pctmale_cent*pct_highschool_or_less_cent+pctmale_cent*pct_Adults_with_Diabetes_cent+pctblack_cent*pct_highschool_or_less_cent+pctblack_cent*pct_Adults_with_Diabetes_cent+pct_highschool_or_less_cent*pct_Adults_with_Diabetes_cent,data = train))
#multi-collinearity
vif(m1)

#RMSE for train data
#create new data set using independent varaibles
train_predict<- subset(train, select = -c(infection_rate_10k_integer))
#predict usin fitted NB 
train$predict_infection<- predict(m1, train_predict,type ="response")
rmse_train<-rmse(train$infection_rate_10k_integer,train$predict_infection)
rmse_train

#Normalized RMSE train
Normalized_rmse_train<- rmse_train/mean(train$infection_rate_10k_integer)
Normalized_rmse_train


#RMSE for test data
test_predict<- subset(test, select = -c(infection_rate_10k_integer))
test$predict_infection<- predict(m1, test_predict,type = "response")
rmse_test<- rmse(test$infection_rate_10k_integer,test$predict_infection)
rmse_test


#Normalized RMSE test
Normalized_rmse_test<- rmse_test/mean(test$infection_rate_10k_integer)
Normalized_rmse_test
```

##############################################
###############################################
##############################################

############################
Regression Analysis
############################

FATALITY

#Phase 1 low fatality model 1(This one has all zeros for falaity.Thus no point of modeling)

#Phase 1 medium fatality model 2
```{r}
#Removing outliers

cluster_medium_fat_dataphase1<- filter_if(cluster_medium_fat_dataphase1, is.numeric, all_vars((.) != 0))
summary(cluster_medium_fat_dataphase1$fatality_rate_10k)
iqr<-IQR(cluster_medium_fat_dataphase1$fatality_rate_10k)
Tmax = 281.690+3*iqr #consider extreme outlires
Tmin = 114.286 -3*iqr #consider extreme outlires
#outliers
outl<- subset(cluster_medium_fat_dataphase1,cluster_medium_fat_dataphase1$fatality_rate_10k<Tmin| cluster_medium_fat_dataphase1$fatality_rate_10k>Tmax)
#cleaned data
cleaned_data<- subset(cluster_medium_fat_dataphase1,cluster_medium_fat_dataphase1$fatality_rate_10k>Tmin & cluster_medium_fat_dataphase1$fatality_rate_10k<Tmax)
#normality test
shapiro.test(cleaned_data$fatality_rate_10k)

#Now I fit the NB model for infection_rate_10k in cleaned data

#convert infection rate into integers
cleaned_data$fatality_rate_10k_integer<-round(cleaned_data$fatality_rate_10k,digits = 0)

#split data set into training and testing
#make this example reproducible
set.seed(1)

#use 70% of dataset as training set and 30% as test set
sample <- sample(c(TRUE, FALSE), nrow(cleaned_data), replace=TRUE, prob=c(0.8,0.2))
train  <- cleaned_data[sample, ]
test   <- cleaned_data[!sample, ]

#fit NB model to training set
summary(m1 <- glm.nb(fatality_rate_10k_integer~popdense+ageab65+pctpov+pctmale+pctwhite+pctblack+pcthispanic+pct_highschool_or_less+pct_Adults_with_Diabetes+pct_Adults_with_Obesity,data = train))
vif(m1)

summary(m1 <- glm.nb(fatality_rate_10k_integer~popdense+ageab65+pctpov+pctmale+pctblack+pcthispanic+pct_highschool_or_less+pct_Adults_with_Diabetes+pct_Adults_with_Obesity,data = train))
vif(m1)

#RMSE for train data
#create new data set using independent varaibles
train_predict<- subset(train, select = -c(fatality_rate_10k_integer))
#predict using fitted NB 
train$predict_fatality<- predict(m1, train_predict,type ="response")
rmse_train<-rmse(train$fatality_rate_10k_integer,train$predict_fatality)
rmse_train

#Normalized RMSE train
Normalized_rmse_train<- rmse_train/mean(train$fatality_rate_10k_integer)
Normalized_rmse_train


#RMSE for test data
test_predict<- subset(test, select = -c(fatality_rate_10k_integer))
test$predict_fatality<- predict(m1, test_predict,type = "response")
rmse_test<- rmse(test$fatality_rate_10k_integer,test$predict_fatality)
rmse_test


#Normalized RMSE test
Normalized_rmse_test<- rmse_test/mean(test$fatality_rate_10k_integer)
Normalized_rmse_test
```

#Phase 1 high fatality model 3

```{r}
#Removing outliers

summary(cluster_high_fat_dataphase1$fatality_rate_10k)
iqr<-IQR(cluster_high_fat_dataphase1$fatality_rate_10k)
Tmax = 1000.0+3*iqr #consider extreme outlires
Tmin = 553.6 -3*iqr #consider extreme outlires
#outliers
outl<- subset(cluster_high_fat_dataphase1,cluster_high_fat_dataphase1$fatality_rate_10k<Tmin| cluster_high_fat_dataphase1$fatality_rate_10k>Tmax)
#cleaned data
cleaned_data<- subset(cluster_high_fat_dataphase1,cluster_high_fat_dataphase1$fatality_rate_10k>Tmin & cluster_high_fat_dataphase1$fatality_rate_10k<Tmax)
#normality test
shapiro.test(cleaned_data$fatality_rate_10k)

#Now I fit the NB model for infection_rate_10k in cleaned data

#convert infection rate into integers
cleaned_data$fatality_rate_10k_integer<-round(cleaned_data$fatality_rate_10k,digits = 0)

#split data set into training and testing
#make this example reproducible
set.seed(1)

#use 70% of dataset as training set and 30% as test set
sample <- sample(c(TRUE, FALSE), nrow(cleaned_data), replace=TRUE, prob=c(0.8,0.2))
train  <- cleaned_data[sample, ]
test   <- cleaned_data[!sample, ]

#fit NB model to training set
summary(m1 <- glm.nb(fatality_rate_10k_integer~popdense+ageab65+pctpov+pctmale+pctwhite+pctblack+pcthispanic+pct_highschool_or_less+pct_Adults_with_Diabetes+pct_Adults_with_Obesity,data = train))
vif(m1)

summary(m1 <- glm.nb(fatality_rate_10k_integer~popdense+ageab65+pctpov+pctmale+pctblack+pcthispanic+pct_highschool_or_less+pct_Adults_with_Diabetes+pct_Adults_with_Obesity,data = train))
vif(m1)

#RMSE for train data
#create new data set using independent varaibles
train_predict<- subset(train, select = -c(fatality_rate_10k_integer))
#predict usin fitted NB 
train$predict_fatality<- predict(m1, train_predict,type ="response")
rmse_train<-rmse(train$fatality_rate_10k_integer,train$predict_fatality)
rmse_train

#Normalized RMSE train
Normalized_rmse_train<- rmse_train/mean(train$fatality_rate_10k_integer)
Normalized_rmse_train


#RMSE for test data
test_predict<- subset(test, select = -c(fatality_rate_10k_integer))
test$predict_fatality<- predict(m1, test_predict,type = "response")
rmse_test<- rmse(test$fatality_rate_10k_integer,test$predict_fatality)
rmse_test


#Normalized RMSE test
Normalized_rmse_test<- rmse_test/mean(test$fatality_rate_10k_integer)
Normalized_rmse_test
```



#Phase 2 low fatality model 4

```{r}
#Removing outliers

cluster_low_fat_dataphase2<- filter_if(cluster_low_fat_dataphase2, is.numeric, all_vars((.) != 0))
summary(cluster_low_fat_dataphase2$fatality_rate_10k)
iqr<-IQR(cluster_low_fat_dataphase2$fatality_rate_10k)
Tmax = 78.302+3*iqr #consider extreme outlires
Tmin = 47.111 -3*iqr #consider extreme outlires
#outliers
outl<- subset(cluster_low_fat_dataphase2,cluster_low_fat_dataphase2$fatality_rate_10k<Tmin| cluster_low_fat_dataphase2$fatality_rate_10k>Tmax)
#cleaned data
cleaned_data<- subset(cluster_low_fat_dataphase2,cluster_low_fat_dataphase2$fatality_rate_10k>Tmin & cluster_low_fat_dataphase2$fatality_rate_10k<Tmax)
#normality test
shapiro.test(cleaned_data$fatality_rate_10k)

#Now I fit the NB model for infection_rate_10k in cleaned data

#convert infection rate into integers
cleaned_data$fatality_rate_10k_integer<-round(cleaned_data$fatality_rate_10k,digits = 0)

#split data set into training and testing
#make this example reproducible
set.seed(1)

#use 70% of dataset as training set and 30% as test set
sample <- sample(c(TRUE, FALSE), nrow(cleaned_data), replace=TRUE, prob=c(0.8,0.2))
train  <- cleaned_data[sample, ]
test   <- cleaned_data[!sample, ]

#fit NB model to training set
summary(m1 <- glm.nb(fatality_rate_10k_integer~popdense+ageab65+pctpov+pctmale+pctwhite+pctblack+pcthispanic+pct_highschool_or_less+pct_Adults_with_Diabetes+pct_Adults_with_Obesity,data = train))
vif(m1)


#RMSE for train data
#create new data set using independent varaibles
train_predict<- subset(train, select = -c(fatality_rate_10k_integer))
#predict usin fitted NB 
train$predict_fatality<- predict(m1, train_predict,type ="response")
rmse_train<-rmse(train$fatality_rate_10k_integer,train$predict_fatality)
rmse_train

#Normalized RMSE train
Normalized_rmse_train<- rmse_train/mean(train$fatality_rate_10k_integer)
Normalized_rmse_train


#RMSE for test data
test_predict<- subset(test, select = -c(fatality_rate_10k_integer))
test$predict_fatality<- predict(m1, test_predict,type = "response")
rmse_test<- rmse(test$fatality_rate_10k_integer,test$predict_fatality)
rmse_test


#Normalized RMSE test
Normalized_rmse_test<- rmse_test/mean(test$fatality_rate_10k_integer)
Normalized_rmse_test
```


#Phase 2 medium fatality model 5

```{r}
#Removing outliers

summary(cluster_medium_fat_dataphase2$fatality_rate_10k)
iqr<-IQR(cluster_medium_fat_dataphase2$fatality_rate_10k)
Tmax = 165.80+3*iqr #consider extreme outlires
Tmin = 112.35 -3*iqr #consider extreme outlires
#outliers
outl<- subset(cluster_medium_fat_dataphase2,cluster_medium_fat_dataphase2$fatality_rate_10k<Tmin| cluster_medium_fat_dataphase2$fatality_rate_10k>Tmax)
#cleaned data
cleaned_data<- subset(cluster_medium_fat_dataphase2,cluster_medium_fat_dataphase2$fatality_rate_10k>Tmin & cluster_medium_fat_dataphase2$fatality_rate_10k<Tmax)
#normality test
shapiro.test(cleaned_data$fatality_rate_10k)

#Now I fit the NB model for infection_rate_10k in cleaned data

#convert infection rate into integers
cleaned_data$fatality_rate_10k_integer<-round(cleaned_data$fatality_rate_10k,digits = 0)

#split data set into training and testing
#make this example reproducible
set.seed(1)

#use 70% of dataset as training set and 30% as test set
sample <- sample(c(TRUE, FALSE), nrow(cleaned_data), replace=TRUE, prob=c(0.8,0.2))
train  <- cleaned_data[sample, ]
test   <- cleaned_data[!sample, ]

#fit NB model to training set
summary(m1 <- glm.nb(fatality_rate_10k_integer~popdense+ageab65+pctpov+pctmale+pctwhite+pctblack+pcthispanic+pct_highschool_or_less+pct_Adults_with_Diabetes+pct_Adults_with_Obesity,data = train))
vif(m1)

summary(m1 <- glm.nb(fatality_rate_10k_integer~popdense+ageab65+pctpov+pctmale+pctblack+pcthispanic+pct_highschool_or_less+pct_Adults_with_Diabetes+pct_Adults_with_Obesity,data = train))
vif(m1)

#RMSE for train data
#create new data set using independent varaibles
train_predict<- subset(train, select = -c(fatality_rate_10k_integer))
#predict usin fitted NB 
train$predict_fatality<- predict(m1, train_predict,type ="response")
rmse_train<-rmse(train$fatality_rate_10k_integer,train$predict_fatality)
rmse_train

#Normalized RMSE train
Normalized_rmse_train<- rmse_train/mean(train$fatality_rate_10k_integer)
Normalized_rmse_train


#RMSE for test data
test_predict<- subset(test, select = -c(fatality_rate_10k_integer))
test$predict_fatality<- predict(m1, test_predict,type = "response")
rmse_test<- rmse(test$fatality_rate_10k_integer,test$predict_fatality)
rmse_test


#Normalized RMSE test
Normalized_rmse_test<- rmse_test/mean(test$fatality_rate_10k_integer)
Normalized_rmse_test
```


#Phase 2 high fatality model 6

```{r}
#Removing outliers

summary(cluster_high_fat_dataphase2$fatality_rate_10k)
iqr<-IQR(cluster_high_fat_dataphase2$fatality_rate_10k)
Tmax = 330.6+3*iqr #consider extreme outlires
Tmin = 232.6 -3*iqr #consider extreme outlires
#outliers
outl<- subset(cluster_high_fat_dataphase2,cluster_high_fat_dataphase2$fatality_rate_10k<Tmin| cluster_high_fat_dataphase2$fatality_rate_10k>Tmax)
#cleaned data
cleaned_data<- subset(cluster_high_fat_dataphase2,cluster_high_fat_dataphase2$fatality_rate_10k>Tmin & cluster_high_fat_dataphase2$fatality_rate_10k<Tmax)
#normality test
shapiro.test(cleaned_data$fatality_rate_10k)

#Now I fit the NB model for infection_rate_10k in cleaned data

#convert infection rate into integers
cleaned_data$fatality_rate_10k_integer<-round(cleaned_data$fatality_rate_10k,digits = 0)

#split data set into training and testing
#make this example reproducible
set.seed(1)

#use 70% of dataset as training set and 30% as test set
sample <- sample(c(TRUE, FALSE), nrow(cleaned_data), replace=TRUE, prob=c(0.8,0.2))
train  <- cleaned_data[sample, ]
test   <- cleaned_data[!sample, ]

#fit NB model to training set
summary(m1 <- glm.nb(fatality_rate_10k_integer~popdense+ageab65+pctpov+pctmale+pctwhite+pctblack+pcthispanic+pct_highschool_or_less+pct_Adults_with_Diabetes+pct_Adults_with_Obesity,data = train))
vif(m1)

summary(m1 <- glm.nb(fatality_rate_10k_integer~popdense+ageab65+pctpov+pctmale+pctblack+pcthispanic+pct_highschool_or_less+pct_Adults_with_Diabetes+pct_Adults_with_Obesity,data = train))
vif(m1)

#RMSE for train data
#create new data set using independent varaibles
train_predict<- subset(train, select = -c(fatality_rate_10k_integer))
#predict usin fitted NB 
train$predict_fatality<- predict(m1, train_predict,type ="response")
rmse_train<-rmse(train$fatality_rate_10k_integer,train$predict_fatality)
rmse_train

#Normalized RMSE train
Normalized_rmse_train<- rmse_train/mean(train$fatality_rate_10k_integer)
Normalized_rmse_train


#RMSE for test data
test_predict<- subset(test, select = -c(fatality_rate_10k_integer))
test$predict_fatality<- predict(m1, test_predict,type = "response")
rmse_test<- rmse(test$fatality_rate_10k_integer,test$predict_fatality)
rmse_test


#Normalized RMSE test
Normalized_rmse_test<- rmse_test/mean(test$fatality_rate_10k_integer)
Normalized_rmse_test
```

#All year low fatality model 7

```{r}
#Removing outliers

cluster_low_fat_datafull<- filter_if(cluster_low_fat_datafull, is.numeric, all_vars((.) != 0))
summary(cluster_low_fat_datafull$fatality_rate_10k)
iqr<-IQR(cluster_low_fat_datafull$fatality_rate_10k)
Tmax = 88.374 +3*iqr #consider extreme outlires
Tmin = 52.888 -3*iqr #consider extreme outlires
#outliers
outl<- subset(cluster_low_fat_datafull,cluster_low_fat_datafull$fatality_rate_10k<Tmin| cluster_low_fat_datafull$fatality_rate_10k>Tmax)
#cleaned data
cleaned_data<- subset(cluster_low_fat_datafull,cluster_low_fat_datafull$fatality_rate_10k>Tmin & cluster_low_fat_datafull$fatality_rate_10k<Tmax)
#normality test
shapiro.test(cleaned_data$fatality_rate_10k)

#Now I fit the NB model for infection_rate_10k in cleaned data

#convert infection rate into integers
cleaned_data$fatality_rate_10k_integer<-round(cleaned_data$fatality_rate_10k,digits = 0)

#split data set into training and testing
#make this example reproducible
set.seed(1)

#use 70% of dataset as training set and 30% as test set
sample <- sample(c(TRUE, FALSE), nrow(cleaned_data), replace=TRUE, prob=c(0.8,0.2))
train  <- cleaned_data[sample, ]
test   <- cleaned_data[!sample, ]

#fit NB model to training set
summary(m1 <- glm.nb(fatality_rate_10k_integer~popdense+ageab65+pctpov+pctmale+pctwhite+pctblack+pcthispanic+pct_highschool_or_less+pct_Adults_with_Diabetes+pct_Adults_with_Obesity,data = train))
vif(m1)


#RMSE for train data
#create new data set using independent varaibles
train_predict<- subset(train, select = -c(fatality_rate_10k_integer))
#predict usin fitted NB 
train$predict_fatality<- predict(m1, train_predict,type ="response")
rmse_train<-rmse(train$fatality_rate_10k_integer,train$predict_fatality)
rmse_train

#Normalized RMSE train
Normalized_rmse_train<- rmse_train/mean(train$fatality_rate_10k_integer)
Normalized_rmse_train


#RMSE for test data
test_predict<- subset(test, select = -c(fatality_rate_10k_integer))
test$predict_fatality<- predict(m1, test_predict,type = "response")
rmse_test<- rmse(test$fatality_rate_10k_integer,test$predict_fatality)
rmse_test


#Normalized RMSE test
Normalized_rmse_test<- rmse_test/mean(test$fatality_rate_10k_integer)
Normalized_rmse_test
```

#All year medium fatality model 8

```{r}
#Removing outliers

summary(cluster_medium_fat_datafull$fatality_rate_10k)
iqr<-IQR(cluster_medium_fat_datafull$fatality_rate_10k)
Tmax = 187.3 +3*iqr #consider extreme outlires
Tmin = 126.0  -3*iqr #consider extreme outlires
#outliers
outl<- subset(cluster_medium_fat_datafull,cluster_medium_fat_datafull$fatality_rate_10k<Tmin| cluster_medium_fat_datafull$fatality_rate_10k>Tmax)
#cleaned data
cleaned_data<- subset(cluster_medium_fat_datafull,cluster_medium_fat_datafull$fatality_rate_10k>Tmin & cluster_medium_fat_datafull$fatality_rate_10k<Tmax)
#normality test
shapiro.test(cleaned_data$fatality_rate_10k)

#Now I fit the NB model for infection_rate_10k in cleaned data

#convert infection rate into integers
cleaned_data$fatality_rate_10k_integer<-round(cleaned_data$fatality_rate_10k,digits = 0)

#split data set into training and testing
#make this example reproducible
set.seed(1)

#use 70% of dataset as training set and 30% as test set
sample <- sample(c(TRUE, FALSE), nrow(cleaned_data), replace=TRUE, prob=c(0.8,0.2))
train  <- cleaned_data[sample, ]
test   <- cleaned_data[!sample, ]

#fit NB model to training set
summary(m1 <- glm.nb(fatality_rate_10k_integer~popdense+ageab65+pctpov+pctmale+pctwhite+pctblack+pcthispanic+pct_highschool_or_less+pct_Adults_with_Diabetes+pct_Adults_with_Obesity,data = train))
vif(m1)

summary(m1 <- glm.nb(fatality_rate_10k_integer~popdense+ageab65+pctpov+pctmale+pctblack+pcthispanic+pct_highschool_or_less+pct_Adults_with_Diabetes+pct_Adults_with_Obesity,data = train))
vif(m1)


#RMSE for train data
#create new data set using independent varaibles
train_predict<- subset(train, select = -c(fatality_rate_10k_integer))
#predict usin fitted NB 
train$predict_fatality<- predict(m1, train_predict,type ="response")
rmse_train<-rmse(train$fatality_rate_10k_integer,train$predict_fatality)
rmse_train

#Normalized RMSE train
Normalized_rmse_train<- rmse_train/mean(train$fatality_rate_10k_integer)
Normalized_rmse_train


#RMSE for test data
test_predict<- subset(test, select = -c(fatality_rate_10k_integer))
test$predict_fatality<- predict(m1, test_predict,type = "response")
rmse_test<- rmse(test$fatality_rate_10k_integer,test$predict_fatality)
rmse_test


#Normalized RMSE test
Normalized_rmse_test<- rmse_test/mean(test$fatality_rate_10k_integer)
Normalized_rmse_test
```

#All year high fatality model 9

```{r}
#Removing outliers

summary(cluster_high_fat_datafull$fatality_rate_10k)
iqr<-IQR(cluster_high_fat_datafull$fatality_rate_10k)
Tmax = 356.7  +3*iqr #consider extreme outlires
Tmin = 256.6  -3*iqr #consider extreme outlires
#outliers
outl<- subset(cluster_high_fat_datafull,cluster_high_fat_datafull$fatality_rate_10k<Tmin| cluster_high_fat_datafull$fatality_rate_10k>Tmax)
#cleaned data
cleaned_data<- subset(cluster_high_fat_datafull,cluster_high_fat_datafull$fatality_rate_10k>Tmin & cluster_high_fat_datafull$fatality_rate_10k<Tmax)
#normality test
shapiro.test(cleaned_data$fatality_rate_10k)

#Now I fit the NB model for infection_rate_10k in cleaned data

#convert infection rate into integers
cleaned_data$fatality_rate_10k_integer<-round(cleaned_data$fatality_rate_10k,digits = 0)

#split data set into training and testing
#make this example reproducible
set.seed(1)

#use 70% of dataset as training set and 30% as test set
sample <- sample(c(TRUE, FALSE), nrow(cleaned_data), replace=TRUE, prob=c(0.8,0.2))
train  <- cleaned_data[sample, ]
test   <- cleaned_data[!sample, ]

#fit NB model to training set
summary(m1 <- glm.nb(fatality_rate_10k_integer~popdense+ageab65+pctpov+pctmale+pctwhite+pctblack+pcthispanic+pct_highschool_or_less+pct_Adults_with_Diabetes+pct_Adults_with_Obesity,data = train))
vif(m1)

summary(m1 <- glm.nb(fatality_rate_10k_integer~popdense+ageab65+pctpov+pctmale+pctblack+pcthispanic+pct_highschool_or_less+pct_Adults_with_Diabetes+pct_Adults_with_Obesity,data = train))
vif(m1)


#RMSE for train data
#create new data set using independent varaibles
train_predict<- subset(train, select = -c(fatality_rate_10k_integer))
#predict usin fitted NB 
train$predict_fatality<- predict(m1, train_predict,type ="response")
rmse_train<-rmse(train$fatality_rate_10k_integer,train$predict_fatality)
rmse_train

#Normalized RMSE train
Normalized_rmse_train<- rmse_train/mean(train$fatality_rate_10k_integer)
Normalized_rmse_train


#RMSE for test data
test_predict<- subset(test, select = -c(fatality_rate_10k_integer))
test$predict_fatality<- predict(m1, test_predict,type = "response")
rmse_test<- rmse(test$fatality_rate_10k_integer,test$predict_fatality)
rmse_test


#Normalized RMSE test
Normalized_rmse_test<- rmse_test/mean(test$fatality_rate_10k_integer)
Normalized_rmse_test
```

##########################
###Interaction effect - fatality###
##########################
#Phase 2 medium fatality model 5

```{r}
#Removing outliers

summary(cluster_medium_fat_dataphase2$fatality_rate_10k)
iqr<-IQR(cluster_medium_fat_dataphase2$fatality_rate_10k)
Tmax = 165.80+3*iqr #consider extreme outlires
Tmin = 112.35 -3*iqr #consider extreme outlires
#outliers
outl<- subset(cluster_medium_fat_dataphase2,cluster_medium_fat_dataphase2$fatality_rate_10k<Tmin| cluster_medium_fat_dataphase2$fatality_rate_10k>Tmax)
#cleaned data
cleaned_data<- subset(cluster_medium_fat_dataphase2,cluster_medium_fat_dataphase2$fatality_rate_10k>Tmin & cluster_medium_fat_dataphase2$fatality_rate_10k<Tmax)
#normality test
shapiro.test(cleaned_data$fatality_rate_10k)

#Now I fit the NB model for infection_rate_10k in cleaned data

#convert infection rate into integers
cleaned_data$fatality_rate_10k_integer<-round(cleaned_data$fatality_rate_10k,digits = 0)

#split data set into training and testing
#make this example reproducible
set.seed(1)

#use 70% of dataset as training set and 30% as test set
sample <- sample(c(TRUE, FALSE), nrow(cleaned_data), replace=TRUE, prob=c(0.8,0.2))
train  <- cleaned_data[sample, ]
test   <- cleaned_data[!sample, ]

#fit NB model to training set
summary(m1 <- glm.nb(fatality_rate_10k_integer~popdense+ageab65+pctpov+pctmale+pctwhite+pctblack+pcthispanic+pct_highschool_or_less+pct_Adults_with_Diabetes+pct_Adults_with_Obesity,data = train))
vif(m1)

summary(m1 <- glm.nb(fatality_rate_10k_integer~popdense+ageab65+pctpov+pctmale+pctblack+pcthispanic+pct_highschool_or_less+pct_Adults_with_Diabetes+pct_Adults_with_Obesity,data = train))
vif(m1)



#with Interaction effect(Uncentered)- consider all the varaibles for the analysis
summary(m1 <- glm.nb(fatality_rate_10k_integer~popdense+ageab65+pctpov+pctmale+pct_highschool_or_less+pct_Adults_with_Diabetes+pct_Adults_with_Obesity + pctblack+pcthispanic + 
                       popdense*ageab65 + popdense*pctpov + popdense*pctmale+ popdense*pct_highschool_or_less + popdense * pct_Adults_with_Diabetes + popdense* pct_Adults_with_Obesity + 
                       ageab65*pctpov+ ageab65*pctmale +ageab65* pct_highschool_or_less+ ageab65* pct_Adults_with_Diabetes + ageab65 *pct_Adults_with_Obesity + 
                       pctpov*pctmale + pctpov*pct_highschool_or_less + pctpov *pct_Adults_with_Diabetes + pctpov*pct_Adults_with_Obesity + 
                       pctmale* pct_highschool_or_less + pctmale * pct_Adults_with_Diabetes + pctmale* pct_Adults_with_Obesity + 
                       pct_highschool_or_less * pct_Adults_with_Diabetes + pct_highschool_or_less * pct_Adults_with_Obesity + 
                       pct_Adults_with_Diabetes * pct_Adults_with_Obesity +
                       
                       pctblack*popdense+pctblack*ageab65+pctblack*pctpov+pctblack*pctmale+pctblack*pct_highschool_or_less+pctblack*pct_Adults_with_Diabetes+pctblack*pct_Adults_with_Obesity +
                       
                       pcthispanic*popdense+pcthispanic*ageab65+pcthispanic*pctpov+pcthispanic*pctmale+pcthispanic*pct_highschool_or_less+pcthispanic*pct_Adults_with_Diabetes+pcthispanic*pct_Adults_with_Obesity + pcthispanic*pctblack,data = train))



#only with significant variable
summary(m1 <- glm.nb(fatality_rate_10k_integer~popdense+ageab65+pctblack+pct_highschool_or_less,data = train))
vif(m1)

#with interaction
summary(m1 <- glm.nb(fatality_rate_10k_integer~popdense+ageab65+pctblack+pcthispanic+pct_highschool_or_less+popdense*ageab65+popdense*pctblack+popdense*pct_highschool_or_less+ageab65*pctblack+ageab65*pct_highschool_or_less+pctblack*pct_highschool_or_less + pcthispanic*popdense +pcthispanic* ageab65 + pcthispanic*pctblack + pcthispanic *pct_highschool_or_less ,data = train))

#RMSE for train data
#create new data set using independent varaibles
train_predict<- subset(train, select = -c(fatality_rate_10k_integer))
#predict usin fitted NB 
train$predict_fatality<- predict(m1, train_predict,type ="response")
rmse_train<-rmse(train$fatality_rate_10k_integer,train$predict_fatality)
rmse_train

#Normalized RMSE train
Normalized_rmse_train<- rmse_train/mean(train$fatality_rate_10k_integer)
Normalized_rmse_train


#RMSE for test data
test_predict<- subset(test, select = -c(fatality_rate_10k_integer))
test$predict_fatality<- predict(m1, test_predict,type = "response")
rmse_test<- rmse(test$fatality_rate_10k_integer,test$predict_fatality)
rmse_test


#Normalized RMSE test
Normalized_rmse_test<- rmse_test/mean(test$fatality_rate_10k_integer)
Normalized_rmse_test

##################
#center predictors
#################

#with Interaction effect(Uncentered)
summary(m1 <- glm.nb(fatality_rate_10k_integer~popdense+ageab65+pctblack+pct_highschool_or_less+popdense*ageab65+popdense*pctblack+popdense*pct_highschool_or_less+ageab65*pctblack+ageab65*pct_highschool_or_less+pctblack*pct_highschool_or_less,data = train))
#multi-collinearity
vif(m1)

#we can center predictors for both train and testing tests
train$popdense_cent<- train$popdense - mean(train$popdense)
train$ageab65_cent<- train$ageab65 - mean(train$ageab65)
train$pctblack_cent<- train$pctblack - mean(train$pctblack)
train$pct_highschool_or_less_cent<- train$pct_highschool_or_less - mean(train$pct_highschool_or_less)


test$popdense_cent<- test$popdense - mean(test$popdense)
test$ageab65_cent<- test$ageab65 - mean(test$ageab65)
test$pctblack_cent<- test$pctblack - mean(test$pctblack)
test$pct_highschool_or_less_cent<- test$pct_highschool_or_less - mean(test$pct_highschool_or_less)

#now let's check with interaction for centered data
#with interaction(centered)
summary(m1 <- glm.nb(fatality_rate_10k_integer~popdense_cent+ageab65_cent+pctblack_cent+pct_highschool_or_less_cent+popdense_cent*ageab65_cent+popdense_cent*pctblack_cent+popdense_cent*pct_highschool_or_less_cent+ageab65_cent*pctblack_cent+ageab65_cent*pct_highschool_or_less_cent+pctblack_cent*pct_highschool_or_less_cent,data = train))
#multi-collinearity
vif(m1)

#RMSE for train data
#create new data set using independent varaibles
train_predict<- subset(train, select = -c(fatality_rate_10k_integer))
#predict usin fitted NB 
train$predict_fatality<- predict(m1, train_predict,type ="response")
rmse_train<-rmse(train$fatality_rate_10k_integer,train$predict_fatality)
rmse_train

#Normalized RMSE train
Normalized_rmse_train<- rmse_train/mean(train$fatality_rate_10k_integer)
Normalized_rmse_train


#RMSE for test data
test_predict<- subset(test, select = -c(fatality_rate_10k_integer))
test$predict_fatality<- predict(m1, test_predict,type = "response")
rmse_test<- rmse(test$fatality_rate_10k_integer,test$predict_fatality)
rmse_test


#Normalized RMSE test
Normalized_rmse_test<- rmse_test/mean(test$fatality_rate_10k_integer)
Normalized_rmse_test
```

#All year medium fatality model 8

```{r}
#Removing outliers

summary(cluster_medium_fat_datafull$fatality_rate_10k)
iqr<-IQR(cluster_medium_fat_datafull$fatality_rate_10k)
Tmax = 187.3 +3*iqr #consider extreme outlires
Tmin = 126.0  -3*iqr #consider extreme outlires
#outliers
outl<- subset(cluster_medium_fat_datafull,cluster_medium_fat_datafull$fatality_rate_10k<Tmin| cluster_medium_fat_datafull$fatality_rate_10k>Tmax)
#cleaned data
cleaned_data<- subset(cluster_medium_fat_datafull,cluster_medium_fat_datafull$fatality_rate_10k>Tmin & cluster_medium_fat_datafull$fatality_rate_10k<Tmax)
#normality test
shapiro.test(cleaned_data$fatality_rate_10k)

#Now I fit the NB model for infection_rate_10k in cleaned data

#convert infection rate into integers
cleaned_data$fatality_rate_10k_integer<-round(cleaned_data$fatality_rate_10k,digits = 0)

#split data set into training and testing
#make this example reproducible
set.seed(1)

#use 70% of dataset as training set and 30% as test set
sample <- sample(c(TRUE, FALSE), nrow(cleaned_data), replace=TRUE, prob=c(0.8,0.2))
train  <- cleaned_data[sample, ]
test   <- cleaned_data[!sample, ]

#fit NB model to training set
summary(m1 <- glm.nb(fatality_rate_10k_integer~popdense+ageab65+pctpov+pctmale+pctwhite+pctblack+pcthispanic+pct_highschool_or_less+pct_Adults_with_Diabetes+pct_Adults_with_Obesity,data = train))
vif(m1)

summary(m1 <- glm.nb(fatality_rate_10k_integer~popdense+ageab65+pctpov+pctmale+pctblack+pct_highschool_or_less+pct_Adults_with_Diabetes+pct_Adults_with_Obesity,data = train))
vif(m1)

#with significant varaiables
summary(m1 <- glm.nb(fatality_rate_10k_integer~ageab65+pctblack+pct_highschool_or_less,data = train))
vif(m1)

#with interaction
summary(m1 <- glm.nb(fatality_rate_10k_integer~ageab65+pctblack+pct_highschool_or_less+ageab65*pctblack+ageab65*pct_highschool_or_less+pctblack*pct_highschool_or_less,data = train))

#RMSE for train data
#create new data set using independent varaibles
train_predict<- subset(train, select = -c(fatality_rate_10k_integer))
#predict usin fitted NB 
train$predict_fatality<- predict(m1, train_predict,type ="response")
rmse_train<-rmse(train$fatality_rate_10k_integer,train$predict_fatality)
rmse_train

#Normalized RMSE train
Normalized_rmse_train<- rmse_train/mean(train$fatality_rate_10k_integer)
Normalized_rmse_train


#RMSE for test data
test_predict<- subset(test, select = -c(fatality_rate_10k_integer))
test$predict_fatality<- predict(m1, test_predict,type = "response")
rmse_test<- rmse(test$fatality_rate_10k_integer,test$predict_fatality)
rmse_test


#Normalized RMSE test
Normalized_rmse_test<- rmse_test/mean(test$fatality_rate_10k_integer)
Normalized_rmse_test

##################
#center predictors
#################

#with Interaction effect(Uncentered)
summary(m1 <- glm.nb(fatality_rate_10k_integer~ageab65+pctblack+pct_highschool_or_less+ageab65*pctblack+ageab65*pct_highschool_or_less+pctblack*pct_highschool_or_less,data = train))
#multi-collinearity
vif(m1)

#we can center predictors for both train and testing tests
train$ageab65_cent<- train$ageab65 - mean(train$ageab65)
train$pctblack_cent<- train$pctblack - mean(train$pctblack)
train$pct_highschool_or_less_cent<- train$pct_highschool_or_less - mean(train$pct_highschool_or_less)

test$ageab65_cent<- test$ageab65 - mean(test$ageab65)
test$pctblack_cent<- test$pctblack - mean(test$pctblack)
test$pct_highschool_or_less_cent<- test$pct_highschool_or_less - mean(test$pct_highschool_or_less)

#now let's check with interaction for centered data
#with interaction(centered)
summary(m1 <- glm.nb(fatality_rate_10k_integer~ageab65_cent+pctblack_cent+pct_highschool_or_less_cent+ageab65_cent*pctblack_cent+ageab65_cent*pct_highschool_or_less_cent+pctblack_cent*pct_highschool_or_less_cent,data = train))
#multi-collinearity
vif(m1)

#RMSE for train data
#create new data set using independent varaibles
train_predict<- subset(train, select = -c(fatality_rate_10k_integer))
#predict usin fitted NB 
train$predict_fatality<- predict(m1, train_predict,type ="response")
rmse_train<-rmse(train$fatality_rate_10k_integer,train$predict_fatality)
rmse_train

#Normalized RMSE train
Normalized_rmse_train<- rmse_train/mean(train$fatality_rate_10k_integer)
Normalized_rmse_train


#RMSE for test data
test_predict<- subset(test, select = -c(fatality_rate_10k_integer))
test$predict_fatality<- predict(m1, test_predict,type = "response")
rmse_test<- rmse(test$fatality_rate_10k_integer,test$predict_fatality)
rmse_test


#Normalized RMSE test
Normalized_rmse_test<- rmse_test/mean(test$fatality_rate_10k_integer)
Normalized_rmse_test
```


############################################################################
Try to see if we can improve models for 
Infection rate - phase 1 :low,medium,high and phase 2 : low, all year : low
Fatality rate - phase 1: medium, high, phase 2: low, high, phase 3: low, high
############################################################################


```{r}
#Removing outliers
summary(cluster_low_inf_dataphase2$infection_rate_10k)
iqr<-IQR(cluster_low_inf_dataphase2$infection_rate_10k)
Tmax = 395.4+3*iqr #consider extreme outlires
Tmin = 250.1-3*iqr #consider extreme outlires
#outliers
outl<- subset(cluster_low_inf_dataphase2,cluster_low_inf_dataphase2$infection_rate_10k<Tmin| cluster_low_inf_dataphase2$infection_rate_10k>Tmax)
#cleaned data
cleaned_data<- subset(cluster_low_inf_dataphase2,cluster_low_inf_dataphase2$infection_rate_10k>Tmin & cluster_low_inf_dataphase2$infection_rate_10k<Tmax)
#normality test
shapiro.test(cleaned_data$infection_rate_10k)

#summary(cleaned_data$infection_rate_10k)
#Normalize data(since data is not normally distributed we cannot use z score)
#cleaned_data$normalized_infection_rate_10k<- (cleaned_data$infection_rate_10k-63.17)/(321.49-63.17)

#(But fitting NB model to a standardized data doesn't make any sense.Therefore we decided to fit a model after removing outliers)

#Now I fit the NB model for infection_rate_10k in cleaned data

#convert infection rate into integers
cleaned_data$infection_rate_10k_integer<-round(cleaned_data$infection_rate_10k,digits = 0)

#split data set into training and testing
#make this example reproducible
set.seed(1)

#use 80% of dataset as training set and 20% as test set
sample <- sample(c(TRUE, FALSE), nrow(cleaned_data), replace=TRUE, prob=c(0.8,0.2))
train  <- cleaned_data[sample, ]
test   <- cleaned_data[!sample, ]

#fit NB model to training set
summary(m1 <- glm.nb(infection_rate_10k_integer~popdense+ageab65+pctpov+pctmale+pctwhite+pctblack+pcthispanic+pct_highschool_or_less+pct_Adults_with_Diabetes+pct_Adults_with_Obesity,data = train))
vif(m1)

#remove high vif(>5)
summary(m1 <- glm.nb(infection_rate_10k_integer~popdense+ageab65+pctpov+pctblack + pcthispanic+ pctmale+pct_highschool_or_less+pct_Adults_with_Diabetes+pct_Adults_with_Obesity,data = train))
vif(m1)

#RMSE for train data
#create new data set using independent varaibles
train_predict<- subset(train, select = -c(infection_rate_10k_integer))
#predict usin fitted NB 
train$predict_infection<- predict(m1, train_predict,type ="response")
rmse_train<-rmse(train$infection_rate_10k_integer,train$predict_infection)
rmse_train

#Normalized RMSE train
Normalized_rmse_train<- rmse_train/mean(train$infection_rate_10k_integer)
Normalized_rmse_train


#RMSE for test data
test_predict<- subset(test, select = -c(infection_rate_10k_integer))
test$predict_infection<- predict(m1, test_predict,type = "response")
rmse_test<- rmse(test$infection_rate_10k_integer,test$predict_infection)
rmse_test


#Normalized RMSE test
Normalized_rmse_test<- rmse_test/mean(test$infection_rate_10k_integer)
Normalized_rmse_test

#with Interaction effect(Uncentered)- consider all the varaibles for the analysis
summary(m1 <- glm.nb(infection_rate_10k_integer~popdense+ageab65+pctpov+pctmale+pct_highschool_or_less+pct_Adults_with_Diabetes+pct_Adults_with_Obesity + pctblack + popdense*ageab65 + popdense*pctpov + popdense*pctmale+ popdense*pct_highschool_or_less + popdense * pct_Adults_with_Diabetes + popdense* pct_Adults_with_Obesity + ageab65*pctpov+ ageab65*pctmale +ageab65* pct_highschool_or_less+ ageab65* pct_Adults_with_Diabetes + ageab65 *pct_Adults_with_Obesity + pctpov*pctmale + pctpov*pct_highschool_or_less + pctpov *pct_Adults_with_Diabetes + pctpov*pct_Adults_with_Obesity + pctmale* pct_highschool_or_less + pctmale * pct_Adults_with_Diabetes + pctmale* pct_Adults_with_Obesity + pct_highschool_or_less * pct_Adults_with_Diabetes + pct_highschool_or_less * pct_Adults_with_Obesity + pct_Adults_with_Diabetes * pct_Adults_with_Obesity +                   pctblack*popdense+pctblack*ageab65+pctblack*pctpov+pctblack*pctmale+pctblack*pct_highschool_or_less+pctblack*pct_Adults_with_Diabetes+pctblack*pct_Adults_with_Obesity +
                       # pctwhite*popdense+pctwhite*ageab65+pctwhite*pctpov+pctwhite*pctmale+pctwhite*pct_highschool_or_less+pctwhite*pct_Adults_with_Diabetes+pctwhite*pct_Adults_with_Obesity + pctwhite*pctblack+
                       pcthispanic*popdense+pcthispanic*ageab65+pcthispanic*pctpov+pcthispanic*pctmale+pcthispanic*pct_highschool_or_less+pcthispanic*pct_Adults_with_Diabetes+pcthispanic*pct_Adults_with_Obesity + pcthispanic*pctblack,data = train))
#multi-collinearity
vif(m1)

#RMSE for train data
#create new data set using independent varaibles
train_predict<- subset(train, select = -c(infection_rate_10k_integer))
#predict usin fitted NB 
train$predict_infection<- predict(m1, train_predict,type ="response")
rmse_train<-rmse(train$infection_rate_10k_integer,train$predict_infection)
rmse_train

#Normalized RMSE train
Normalized_rmse_train<- rmse_train/mean(train$infection_rate_10k_integer)
Normalized_rmse_train


#RMSE for test data
test_predict<- subset(test, select = -c(infection_rate_10k_integer))
test$predict_infection<- predict(m1, test_predict,type = "response")
rmse_test<- rmse(test$infection_rate_10k_integer,test$predict_infection)
rmse_test


#Normalized RMSE test
Normalized_rmse_test<- rmse_test/mean(test$infection_rate_10k_integer)
Normalized_rmse_test
```

```{r}
plot(cluster_high_inf_dataphase1$infection_rate_10k)
plot(cluster_high_fat_dataphase1$fatality_rate_10k)
```

